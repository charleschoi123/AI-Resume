<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alsos NeuroMatch · 求职助手</title>
  <style>
    :root{--bg:#0b0f15;--card:#121826;--ink:#e8eefc;--muted:#96a2bf;--accent:#7c9cff;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",PingFang SC,Helvetica,Arial;}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px;}
    h1{font-size:26px;margin:0 0 18px;letter-spacing:.2px}
    .row{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .card{background:var(--card);border:1px solid #1d2435;border-radius:14px;padding:14px 14px}
    .card h3{margin:0 0 8px;font-size:16px;font-weight:600;color:#dfe7ff}
    textarea, input, select{width:100%;box-sizing:border-box;background:#0d1320;border:1px solid #293148;border-radius:10px;color:var(--ink);padding:10px 12px;outline:none}
    textarea{min-height:220px;resize:vertical;line-height:1.55}
    .muted{color:var(--muted);font-size:12px}
    .bar{height:8px;background:#0e1527;border-radius:999px;overflow:hidden;border:1px solid #28324a}
    .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#6aa5ff,#b38bff);transition:width .35s ease}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{appearance:none;border:1px solid #2f3852;background:#0f1526;color:#eaf1ff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .primary{background:linear-gradient(90deg,#5b8dff,#7d67ff);border-color:transparent}
    .ghost{background:#0f1423}
    .section{margin-top:18px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .block{white-space:pre-wrap;background:#0c1322;border:1px solid #253050;border-radius:12px;padding:12px;color:#cfe0ff;font-family:ui-monospace,Consolas,Monaco,monospace;overflow:auto}
    .tag{display:inline-block;font-size:12px;padding:3px 8px;border-radius:999px;background:#101832;border:1px solid #283659;margin:0 6px 6px 0}
    .job{background:#0e1527;border:1px solid #283659;border-radius:14px;padding:12px;margin-bottom:10px}
    .job h4{margin:0 0 4px}
    .job a{color:#9ec1ff;text-decoration:none}
    .footerNote{margin-top:8px;color:#8fa0c6;font-size:12px}
    @media print{
      body{background:#fff;color:#000}
      .wrap{max-width:none}
      .no-print{display:none}
      .card{border:none}
      .block{border:1px solid #ccc;background:#fff;color:#000}
      a{color:#000;text-decoration:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Alsos NeuroMatch · 求职助手</h1>

    <div class="card section">
      <div class="bar"><i id="pbar"></i></div>
      <div class="footerNote">提示：首次生成可能稍慢（Render 冷启动）。</div>
    </div>

    <div class="row section">
      <div class="card">
        <h3>① 粘贴你的简历文本</h3>
        <textarea id="resume_text" placeholder="直接粘贴 PDF/Word 的文字…"></textarea>
        <div class="muted">仅本地使用，不会保存。</div>
      </div>
      <div class="card">
        <h3>② 目标信息</h3>
        <div class="grid2">
          <div><label class="muted">目标职位</label><input id="target_role" placeholder="如：资金总监 / 财务经理"></div>
          <div><label class="muted">期望地点</label><input id="location" placeholder="如：深圳 / 上海 / Remote"></div>
        </div>
        <div class="section">
          <label class="muted">目标行业（可选）</label>
          <input id="industry" placeholder="如：制造 / 金融 / AI" />
        </div>
        <div class="section">
          <label class="muted">目标职位 JD（可选，用于 ATS 评分）</label>
          <textarea id="jd_text" placeholder="粘贴完整 JD 文本…"></textarea>
        </div>
      </div>
    </div>

    <div class="card section no-print">
      <div class="btns">
        <button id="goBtn" class="primary" onclick="runFull()">一键生成报告</button>
        <button onclick="window.print()">导出 PDF</button>
        <button onclick="exportDocx()">导出 DOCX</button>
        <button class="ghost" onclick="doJobSearch()">智能找岗位</button>
      </div>
    </div>

    <div class="row section">
      <div class="card">
        <h3>报告 · 简历优化</h3>
        <div id="optBlock" class="block">尚未生成</div>
      </div>
      <div class="card">
        <h3>报告 · ATS 匹配（若提供 JD）</h3>
        <div id="atsBlock" class="block">尚未生成</div>
      </div>
    </div>

    <div class="row section">
      <div class="card">
        <h3>报告 · 面试问答</h3>
        <div id="qaBlock" class="block">尚未生成</div>
      </div>
      <div class="card">
        <h3>报告 · 职业建议（3-5年）</h3>
        <div id="careerBlock" class="block">尚未生成</div>
      </div>
    </div>

    <div class="card section">
      <h3>在线职位匹配</h3>
      <div id="jobsArea">尚未搜索</div>
      <div class="footerNote">数据源：Jooble（有 Key 时）、无 Key 自动回退 Arbeitnow。按关键词/地点计算匹配度并排序。</div>
    </div>
  </div>

  <script>
    // 进度条
    function setBar(v){ document.getElementById('pbar').style.width = Math.max(0,Math.min(100,v)) + '%'; }

    // 渲染报告
    let lastReport = null;
    function renderReport(j){
      lastReport = j || {};
      // 简历优化
      const opt = j.resume_optimization || {};
      const optText = JSON.stringify(opt, null, 2);
      document.getElementById('optBlock').textContent = optText || '无';

      // ATS
      const ats = j.ats || {};
      const atsText = JSON.stringify(ats, null, 2);
      document.getElementById('atsBlock').textContent = atsText || '无';

      // Q&A
      const qa = j.interview || {};
      const qaText = JSON.stringify(qa, null, 2);
      document.getElementById('qaBlock').textContent = qaText || '无';

      // Career
      const car = j.career || {};
      const carText = JSON.stringify(car, null, 2);
      document.getElementById('careerBlock').textContent = carText || '无';
    }

    // 预热 + 超时控制（补丁A）
    async function runFull(){
      const btn=document.getElementById('goBtn');
      btn.disabled=true; btn.textContent='预热中…'; setBar(10);

      // 预热健康检查，唤醒冷启动
      try{ await fetch('/health', {cache:'no-store'}); }catch(e){}

      btn.textContent='生成中…'; setBar(15);

      const payload={
        resume_text:(document.getElementById('resume_text').value||'').trim(),
        target_role:(document.getElementById('target_role').value||'').trim(),
        location:(document.getElementById('location').value||'').trim(),
        jd_text:(document.getElementById('jd_text').value||'').trim(),
        industry:(document.getElementById('industry').value||'').trim()
      };
      if(!payload.resume_text){
        alert('请先粘贴简历文本'); btn.disabled=false; btn.textContent='一键生成报告'; return;
      }

      const ctrl = new AbortController();
      const timer = setTimeout(()=>ctrl.abort(), 120000); // 120s 超时

      try{
        const r = await fetch('/full_report',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload), signal: ctrl.signal
        });
        clearTimeout(timer);

        const raw = await r.text();
        let j; try{ j=JSON.parse(raw); }catch{ throw new Error('后端返回的不是JSON：'+raw.slice(0,200)); }
        if(!r.ok){ throw new Error(j.error || ('HTTP '+r.status)); }

        renderReport(j); setBar(100);
      }catch(e){
        alert('生成失败：'+ (e.message || e));
        setBar(0);
      }finally{
        btn.disabled=false; btn.textContent='一键生成报告';
      }
    }

    // 导出 DOCX
    async function exportDocx(){
      if(!lastReport){ return alert('请先生成报告'); }
      try{
        const r = await fetch('/export_docx',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({report: lastReport})
        });
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'AI_Resume_Report.docx'; a.click();
        URL.revokeObjectURL(url);
      }catch(e){
        alert('导出失败：'+ (e.message||e));
      }
    }

    // 在线职位匹配
    async function doJobSearch(){
      setBar(20);
      try{
        const js = {
          resume_struct: lastReport?.resume_optimization || {},
          target_role: (document.getElementById('target_role').value||'').trim(),
          location: (document.getElementById('location').value||'').trim(),
          industry: (document.getElementById('industry').value||'').trim(),
          limit: 12
        };
        const r = await fetch('/job_search',{
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(js)
        });
        const raw = await r.text();
        let j; try{ j=JSON.parse(raw);}catch{ throw new Error('返回的不是JSON：'+raw.slice(0,200)); }
        if(!r.ok){ throw new Error(j.error || ('HTTP '+r.status)); }
        renderJobs(j.jobs||[]);
        setBar(100);
      }catch(e){
        alert('职位搜索失败：'+(e.message||e));
        setBar(0);
      }
    }

    function renderJobs(list){
      const box = document.getElementById('jobsArea');
      if(!list.length){ box.innerHTML = '<div class="muted">未找到匹配结果（可更换关键词或地点重试）。</div>'; return; }
      box.innerHTML = list.map(j => `
        <div class="job">
          <h4>${escapeHTML(j.title||'职位')}</h4>
          <div class="muted">${escapeHTML(j.company||'')} · ${escapeHTML(j.location||'')}</div>
          <div class="muted" style="margin:6px 0">${escapeHTML((j.desc||'').slice(0,180))}</div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <span class="tag">来源：${escapeHTML(j.source||'')}</span>
            <span class="tag">匹配度：${j.score||0}</span>
            ${j.link ? `<a class="tag" href="${j.link}" target="_blank" rel="noopener">查看详情</a>`:''}
          </div>
        </div>
      `).join('');
    }

    function escapeHTML(s){ return (s||'').replace(/[&<>"]/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m])); }
  </script>
</body>
</html>
