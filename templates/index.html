<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alsos AI Resume · 求职助手</title>
<style>
  :root{--bg:#F3F2EF;--card:#fff;--text:#111827;--muted:#6B7280;--border:#E5E7EB;--brand:#0D3B2E;--brand-weak:#E7F0ED;--warn:#fffce7;--warn-b:#f3e7a6;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,sans-serif}
  .topbar{height:56px;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px;position:sticky;top:0;z-index:10}
  .brand{font-weight:800;color:var(--brand)} .hint{color:var(--muted);font-size:12px}
  .container{max-width:1100px;margin:16px auto;padding:0 12px;display:grid;grid-template-columns:360px 1fr;gap:16px}
  @media (max-width:980px){.container{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .title{padding:12px 16px;font-weight:700;color:var(--brand);border-bottom:1px solid var(--border)}
  .content{padding:14px 16px;line-height:1.65}
  .section-title{padding:14px 16px;font-weight:700;border-bottom:1px solid var(--border);color:var(--brand)}
  .body{padding:14px 16px}
  .row{display:flex;gap:10px;margin-bottom:10px}
  input[type=text],textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#FAFAFA;outline:none}
  textarea{min-height:140px;resize:vertical}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:1px solid transparent;cursor:pointer;transition:all .15s ease}
  .btn-primary{background:var(--brand);color:#fff}.btn-primary:hover{opacity:.9}
  .btn-ghost{background:#EEF2F3;color:var(--brand);border-color:#DDE4E6}.btn-ghost:hover{background:#E7ECEE}
  .pill{display:inline-block;padding:4px 8px;background:var(--brand-weak);border-radius:999px;margin:0 6px 6px 0}
  .muted{color:var(--muted);font-size:12px}
  .banner{background:var(--warn);border:1px solid var(--warn-b);color:#8b6a00;padding:8px 12px;border-radius:10px;margin-bottom:12px;font-size:13px}
  .progress-wrap{background:#EEF2F3;border:1px solid var(--border);border-radius:10px;overflow:hidden;height:14px}
  .progress-bar{height:100%;background:var(--brand);width:0%}
  .progress-text{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}
  .skeleton{animation:pulse 1.2s infinite ease-in-out;background:#EAECEE;height:14px;border-radius:8px;margin:8px 0}
  @keyframes pulse{0%{opacity:.8}50%{opacity:.4}100%{opacity:.8}}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Alsos AI Resume</div>
    <div class="hint" id="cacheHint" style="display:none;">已加载上次结果 · <a href="#" id="btnClearCache">清空缓存</a></div>
  </div>

  <div class="container">
    <div class="card">
      <div class="section-title">输入区</div>
      <div class="body">
        <div class="row"><input type="file" id="resumeFile" accept=".txt,.docx"/></div>
        <div class="row"><textarea id="resumeText" placeholder="① 粘贴简历（中/英）&#10;② 或上传 .txt/.docx 自动填充"></textarea></div>
        <div class="row"><input id="targetTitle" type="text" placeholder="目标职位"/></div>
        <div class="row"><input id="targetLocation" type="text" placeholder="期望地点"/></div>
        <div class="row"><input id="targetIndustry" type="text" placeholder="目标行业（可选）"/></div>
        <div class="row"><textarea id="jobDescription" placeholder="目标职位 JD（可选，用于 ATS）"></textarea></div>
        <div class="row" style="gap:8px;">
          <button class="btn btn-primary" id="btnGenerate">一键生成（流式）</button>
          <button class="btn btn-ghost" id="btnClear">清空输入</button>
        </div>
        <div class="muted">提示：生成过程中会逐步出现各模块。</div>
      </div>
    </div>

    <div class="feed" id="feed"></div>
  </div>

<script>
const $ = s => document.querySelector(s);
const feed = $("#feed"); const cacheKey = "alsos_last_report_stream_v1";
const escapeHtml = s => (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function card(id, title, inner=""){
  const el = document.createElement("div");
  el.className="card"; el.id=id;
  el.innerHTML=`<div class="title">${title}</div><div class="content">${inner}</div>`;
  feed.appendChild(el);
  return el.querySelector(".content");
}
function pillList(arr){ return (arr||[]).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join(""); }

function progressCard(){
  const el = card("card-progress","正在分析简历",`
    <div class="progress-wrap"><div class="progress-bar" id="pgbar"></div></div>
    <div class="progress-text">莫着急、莫着急，你的简历很精彩，容我认真拜读～</div>`);
  let p=0, bar=$("#pgbar");
  const timer=setInterval(()=>{ p+=Math.random()*8+4; if(p>92)p=92; bar.style.width=p+"%"; },400);
  return {finish:()=>{clearInterval(timer); bar.style.width="100%";}};
}

function renderStreamPiece(evt){
  const {section, data} = evt;
  if(section==="summary_highlights"){
    card("card-overview","📌 概览", `<div class="banner">引擎：Alsos AI Resume</div>`);
    card("card-summary","📝 简历 Summary 概要", `<p>${escapeHtml(data.summary||"")}</p>`);
    const hl = data.highlights||[];
    card("card-highlights","🌟 职业亮点", hl.length? `<ul>${hl.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`:"<div class='muted'>亮点待补充</div>");
  }
  if(section==="improvements"){
    const list = (data.resume_improvements||[]).map((it,i)=>`
      <div style="margin-bottom:10px">
        <div><b>${i+1}. 问题点：</b>${escapeHtml(it.issue||"")}</div>
        <div><b>改进方案：</b>${escapeHtml(it.fix||"")}</div>
        <div class="muted"><b>原因：</b>${escapeHtml(it.why||"")}</div>
      </div>`).join("");
    card("card-improve","🔧 简历优化建议", list);
  }
  if(section==="keywords_career"){
    const kw = data.keywords||[];
    card("card-keywords","🔑 核心关键词", kw.length? pillList(kw):"<div class='muted'>关键词不足</div>");
    const cs = data.career_suggestions||{};
    const career = `
      <div><b>短期：</b><ul>${(cs.short_term||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      <div><b>中期：</b><ul>${(cs.mid_term||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      <div><b>长期：</b><ul>${(cs.long_term||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>`;
    card("card-career","📈 求职方向（策略化）", career);
  }
  if(section==="interview"){
    const ih = data.interview_handbook||{};
    const html = `
      <div><b>回答逻辑：</b><ul>${(ih.answer_logic||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      <div><b>岗位层级差异：</b>
        <div><i>Junior</i><ul>${(ih.level_differences?.junior||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
        <div><i>Senior</i><ul>${(ih.level_differences?.senior||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      </div>
      <div><b>不同面试官关注点：</b>
        <div><i>HR</i><ul>${(ih.interviewer_focus?.HR||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
        <div><i>部门负责人</i><ul>${(ih.interviewer_focus?.hiring_manager||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
        <div><i>老板/高层</i><ul>${(ih.interviewer_focus?.executive||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      </div>
      <div><b>STAR 项目答题提示（3 套）：</b>
        <ol>${(ih.star_sets||[]).map(s=>`<li><b>${escapeHtml(s.project_title||"项目")}</b> · ${escapeHtml(s.question||"")}<ul>${(s.how_to_answer||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></li>`).join("")}</ol>
      </div>`;
    card("card-interview","📖 面试手册", html);
  }
  if(section==="ats"){
    const ats = data.ats||{};
    if(!ats.enabled){
      card("card-ats","📊 ATS 匹配", "<div class='muted'>未提供 JD，未进行 ATS 评分。</div>");
    }else{
      const rs = ats.reasons||{};
      const bar = n=>`<div style='display:flex;gap:10px;align-items:center;margin:4px 0'>
        <div style='flex:1;height:12px;background:#EEF2F3;border:1px solid #E5E7EB;border-radius:999px;overflow:hidden'>
          <div style='height:100%;background:#0D3B2E;width:${Math.max(0,Math.min(100,Number(n||0)))}%'></div>
        </div><span class='muted' style='width:48px;text-align:right'>${n||0}/100</span></div>`;
      const html = `
        <div><b>总分：</b>${bar(ats.total_score||0)}</div>
        <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:8px;">
          <div><b>技能</b>${bar(ats.sub_scores?.skills||0)}<div class="muted">${(rs.skills||[]).join(" · ")}</div></div>
          <div><b>经验</b>${bar(ats.sub_scores?.experience||0)}<div class="muted">${(rs.experience||[]).join(" · ")}</div></div>
          <div><b>教育</b>${bar(ats.sub_scores?.education||0)}<div class="muted">${(rs.education||[]).join(" · ")}</div></div>
          <div><b>关键词</b>${bar(ats.sub_scores?.keywords||0)}<div class="muted">${(rs.keywords||[]).join(" · ")}</div></div>
        </div>
        <div style="margin-top:8px;"><b>缺口关键词：</b>${pillList(ats.gap_keywords||[])}</div>
        <div style="margin-top:8px;"><b>优化建议：</b><ul>${(ats.improvement_advice||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      `;
      card("card-ats","📊 ATS 匹配", html);
    }
  }
  if(section==="salary"){
    const s = data.salary_insights||{}, c = s.currency||"CNY";
    const line = (label,val,min,max)=>{
      const hi=Number(max||0), lo=Number(min||0), v=Number(val||0);
      const pct = hi>lo ? Math.max(5,Math.min(100,Math.round((v-lo)/(hi-lo)*100))) : 5;
      return `<div style="display:flex;align-items:center;gap:10px;margin:6px 0">
        <div style="width:36px" class="muted">${label}</div>
        <div style="flex:1;height:12px;background:#EEF2F3;border:1px solid #E5E7EB;border-radius:999px;overflow:hidden">
          <div style="height:100%;background:#0D3B2E;width:${pct}%"></div>
        </div>
        <div style="width:120px;text-align:right" class="muted">${c} ${v}</div></div>`;
    };
    const html = `<div><b>${escapeHtml(s.city||"-")} · ${escapeHtml(s.title||"-")}</b></div>
      ${line("低位",s.low,s.low,s.high)}${line("中位",s.mid,s.low,s.high)}${line("高位",s.high,s.low,s.high)}
      <div class="muted">影响因子：${(s.factors||[]).join(" · ")}</div>
      <div class="muted">${escapeHtml(s.notes||"模型估算，供参考")}</div>`;
    card("card-salary","💰 薪酬估算", html);
  }
  if(section==="done"){
    const ms = data.meta?.elapsed_ms || 0;
    const el = document.getElementById("card-overview")?.querySelector(".content");
    if(el){ el.insertAdjacentHTML("afterbegin", `<div class="banner">耗时：${ms} ms · 引擎：Alsos AI Resume</div>`); }
  }
}

async function startStream(){
  feed.innerHTML = "";
  const progress = progressCard();

  const body = {
    resume_text: $("#resumeText").value.trim(),
    job_description: $("#jobDescription").value.trim(),
    target_title: $("#targetTitle").value.trim(),
    target_location: $("#targetLocation").value.trim(),
    target_industry: $("#targetIndustry").value.trim()
  };
  if(!body.resume_text) { alert("请粘贴简历文本或上传文件"); return; }

  const res = await fetch("/optimize_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  if(!res.ok){ progress.finish(); feed.innerHTML = `<div class="card"><div class="title">错误</div><div class="content">服务暂不可用</div></div>`; return; }

  const reader = res.body.getReader();
  const decoder = new TextDecoder("utf-8");
  let buf = "";

  while(true){
    const {value, done} = await reader.read();
    if(done) break;
    buf += decoder.decode(value,{stream:true});
    const parts = buf.split("\n\n");
    for(let i=0;i<parts.length-1;i++){
      const line = parts[i].trim();
      if(line.startsWith("data:")){
        try{
          const payload = JSON.parse(line.slice(5).trim());
          renderStreamPiece(payload);
        }catch(e){}
      }
    }
    buf = parts[parts.length-1];
  }
  progress.finish();

  // 缓存：把当前页面 DOM 不缓存，存结构化数据（可选：拼整体对象）
  // 这里简化：不做合并缓存，留给后续版本
}

// 事件
$("#btnGenerate").addEventListener("click", startStream);
$("#btnClear").addEventListener("click", ()=>{$("#resumeText").value="";$("#targetTitle").value="";$("#targetLocation").value="";$("#targetIndustry").value="";$("#jobDescription").value="";});
$("#btnClearCache").addEventListener("click",(e)=>{e.preventDefault();localStorage.removeItem(cacheKey);$("#cacheHint").style.display="none";});
$("#resumeFile").addEventListener("change", async (e)=>{
  const f=e.target.files[0]; if(!f) return; const fd=new FormData(); fd.append("file", f);
  const r=await fetch("/extract-text",{method:"POST",body:fd}); const j=await r.json();
  if(j.ok) $("#resumeText").value=j.text||"";
});
</script>
</body>
</html>
