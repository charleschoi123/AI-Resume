<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alsos AI Resume Â· æ±‚èŒåŠ©æ‰‹</title>
  <style>
    :root{
      --bg:#F3F2EF;          /* ç±» LinkedIn èƒŒæ™¯ç° */
      --card:#FFFFFF;        /* å¡ç‰‡ç™½ */
      --text:#111827;        /* ä¸»æ–‡æœ¬ */
      --muted:#6B7280;       /* æ¬¡æ–‡æœ¬ */
      --border:#E5E7EB;      /* è¾¹æ¡†ç° */
      --brand:#0D3B2E;       /* æ·±ç»¿ä¸»è‰² */
      --brand-weak:#E7F0ED;  /* ä¸»è‰²æµ…åº• */
      --accent:#C9A227;      /* ç‚¹ç¼€è‰²ï¼ˆå¯é€‰ï¼‰ */
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text); font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,sans-serif;
    }
    .topbar{
      height:56px; background:var(--card); border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; padding:0 16px; position:sticky; top:0; z-index:10;
    }
    .brand{ font-weight:800; letter-spacing:.3px; color:var(--brand); }
    .hint{ color:var(--muted); font-size:12px }

    .container{ max-width:1100px; margin:16px auto; padding:0 12px; display:grid; grid-template-columns: 360px 1fr; gap:16px; }
    @media (max-width: 980px){ .container{ grid-template-columns: 1fr; } }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.03);
    }
    .card .section-title{
      padding:14px 16px; font-weight:700; border-bottom:1px solid var(--border); color:var(--brand);
    }
    .card .body{ padding:14px 16px; }
    .row{ display:flex; gap:10px; margin-bottom:10px; }
    input[type=text], textarea{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#FAFAFA; outline:none;
    }
    textarea{ min-height:140px; resize:vertical; }
    .muted{ color:var(--muted); font-size:12px; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:10px; border:1px solid transparent; cursor:pointer; user-select:none;
      transition:all .15s ease;
    }
    .btn-primary{ background:var(--brand); color:#fff; }
    .btn-primary:hover{ opacity:.9; }
    .btn-ghost{ background:#EEF2F3; color:var(--brand); border-color:#DDE4E6; }
    .btn-ghost:hover{ background:#E7ECEE; }

    .feed .item{ margin-bottom:14px; overflow:hidden; }
    .feed .item .title{ padding:12px 16px; font-weight:700; color:var(--brand); border-bottom:1px solid var(--border); }
    .feed .item .content{ padding:14px 16px; line-height:1.6; }
    .pill{ display:inline-block; padding:4px 8px; background:var(--brand-weak); border-radius:999px; margin-right:6px; margin-bottom:6px; }
    .scorebar{
      height:10px; background:#EEF2F3; border-radius:999px; overflow:hidden; margin-top:6px; border:1px solid var(--border);
    }
    .scorebar > span{ display:block; height:100%; background:var(--brand); }

    .skeleton{ animation: pulse 1.2s infinite ease-in-out; background:#EAECEE; height:14px; border-radius:8px; margin:8px 0; }
    @keyframes pulse{ 0%{opacity:.8} 50%{opacity:.4} 100%{opacity:.8} }

    .banner{ background:#fffce7; border:1px solid #f3e7a6; color:#8b6a00; padding:8px 12px; border-radius:10px; margin-bottom:12px; font-size:13px; }
    .error{ background:#fff1f1; border:1px solid #ffd0d0; color:#a20000; padding:10px 12px; border-radius:10px; margin-bottom:12px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Alsos AI Resume</div>
    <div class="hint" id="cacheHint" style="display:none;">å·²åŠ è½½ä¸Šæ¬¡ç»“æœ Â· <a href="#" id="btnClearCache">æ¸…ç©ºç¼“å­˜</a></div>
  </div>

  <div class="container">
    <!-- å·¦ä¾§ï¼šè¾“å…¥ -->
    <div class="card">
      <div class="section-title">è¾“å…¥åŒº</div>
      <div class="body">
        <div class="row">
          <input type="file" id="resumeFile" accept=".txt,.docx" />
        </div>
        <div class="row">
          <textarea id="resumeText" placeholder="â‘  ç›´æ¥ç²˜è´´ç®€å†æ–‡æœ¬ï¼ˆæ”¯æŒä¸­æ–‡ï¼‰&#10;â‘¡ æˆ–ä¸Šä¼  .txt / .docx è‡ªåŠ¨å¡«å……"></textarea>
        </div>
        <div class="row">
          <input id="targetTitle" type="text" placeholder="ç›®æ ‡èŒä½ï¼Œå¦‚ï¼šäº§å“ç»ç† / è´¢åŠ¡æ€»ç›‘" />
        </div>
        <div class="row">
          <input id="targetLocation" type="text" placeholder="æœŸæœ›åœ°ç‚¹ï¼Œå¦‚ï¼šä¸Šæµ· / æ·±åœ³" />
        </div>
        <div class="row">
          <input id="targetIndustry" type="text" placeholder="ç›®æ ‡è¡Œä¸šï¼ˆå¯é€‰ï¼‰ï¼Œå¦‚ï¼šäº’è”ç½‘ / åŒ»è¯ / åˆ¶é€ " />
        </div>
        <div class="row">
          <textarea id="jobDescription" placeholder="ç›®æ ‡èŒä½ JDï¼ˆå¯é€‰ï¼Œç”¨äº ATS è¯„åˆ†ï¼‰"></textarea>
        </div>
        <div class="row" style="gap:8px;">
          <button class="btn btn-primary" id="btnGenerate">ä¸€é”®ç”ŸæˆæŠ¥å‘Š</button>
          <button class="btn btn-ghost" id="btnClear">æ¸…ç©ºè¾“å…¥</button>
        </div>
        <div class="muted">æç¤ºï¼šé¦–æ¬¡ç”Ÿæˆå¯èƒ½è¾ƒæ…¢ï¼ˆå†·å¯åŠ¨ + LLM è®¡ç®—ï¼‰ï¼Œå±æ­£å¸¸ã€‚</div>
      </div>
    </div>

    <!-- å³ä¾§ï¼šç»“æœ feed -->
    <div class="feed">
      <div id="alertArea"></div>
      <div id="feedArea">
        <!-- åŠ¨æ€æ¸²æŸ“ -->
      </div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const feed = $("#feedArea");
    const alertArea = $("#alertArea");
    const cacheKey = "alsos_last_report_v1";

    function showBannerCache(){
      const has = !!localStorage.getItem(cacheKey);
      $("#cacheHint").style.display = has ? "block" : "none";
    }

    function skeleton(){
      feed.innerHTML = `
        <div class="card item"><div class="title">æ­£åœ¨ç”ŸæˆæŠ¥å‘Š</div>
          <div class="content">
            <div class="skeleton" style="width:80%"></div>
            <div class="skeleton" style="width:90%"></div>
            <div class="skeleton" style="width:60%"></div>
          </div>
        </div>
        <div class="card item"><div class="title">è¯·ç¨å€™</div>
          <div class="content">
            <div class="skeleton" style="width:95%"></div>
            <div class="skeleton" style="width:70%"></div>
            <div class="skeleton" style="width:85%"></div>
          </div>
        </div>
      `;
    }

    function pillList(arr){
      return (arr||[]).map(x => `<span class="pill">${escapeHtml(x)}</span>`).join("");
    }

    function scoreBar(v){ const clamped = Math.max(0, Math.min(100, Number(v||0))); return `
      <div class="scorebar"><span style="width:${clamped}%"></span></div>
      <div class="muted">${clamped}/100</div>`;}

    function card(title, html){
      return `<div class="card item">
        <div class="title">${title}</div>
        <div class="content">${html}</div>
      </div>`;
    }

    function renderReport(data){
      alertArea.innerHTML = "";
      const d = data.data;
      const meta = d.meta || {};
      const ats  = d.ats  || {};

      const overview = `
        <div class="banner">è€—æ—¶ï¼š${(meta.elapsed_ms||0)} ms Â· å¼•æ“ï¼š${meta.model_alias||"Alsos AI Resume"}</div>
        <div class="muted">è‹¥æä¾› JD å°†ç”Ÿæˆ ATS åŒ¹é…è¯„åˆ†ï¼›æœªæä¾›åˆ™ä¸åš ATSã€‚</div>`;

      const summary = `<p>${escapeHtml(d.summary||"")}</p>`;
      const highlights = pillList(d.highlights);
      const keywords = pillList(d.keywords);

      const career = `
        <div><b>çŸ­æœŸï¼š</b><ul>${(d.career_suggestions?.short_term||[]).map(li => `<li>${escapeHtml(li)}</li>`).join("")}</ul></div>
        <div><b>ä¸­æœŸï¼š</b><ul>${(d.career_suggestions?.mid_term||[]).map(li => `<li>${escapeHtml(li)}</li>`).join("")}</ul></div>
        <div><b>é•¿æœŸï¼š</b><ul>${(d.career_suggestions?.long_term||[]).map(li => `<li>${escapeHtml(li)}</li>`).join("")}</ul></div>`;

      const interview = `
        <div><b>é€šç”¨é—®é¢˜ï¼š</b><ul>${(d.interview_prep?.general||[]).map(li => `<li>${escapeHtml(li)}</li>`).join("")}</ul></div>
        <div><b>å²—ä½ç›¸å…³ï¼š</b><ul>${(d.interview_prep?.role_specific||[]).map(li => `<li>${escapeHtml(li)}</li>`).join("")}</ul></div>
        <div class="muted"><b>STAR æç¤ºï¼š</b>${escapeHtml(d.interview_prep?.star_tips||"")}</div>`;

      let atsHtml = "";
      if (ats.enabled){
        atsHtml = `
          <div><b>æ€»åˆ†ï¼š</b>${scoreBar(ats.total_score||0)}</div>
          <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:8px;">
            <div><b>æŠ€èƒ½</b>${scoreBar(ats.sub_scores?.skills||0)}</div>
            <div><b>ç»éªŒ</b>${scoreBar(ats.sub_scores?.experience||0)}</div>
            <div><b>æ•™è‚²</b>${scoreBar(ats.sub_scores?.education||0)}</div>
            <div><b>å…³é”®è¯</b>${scoreBar(ats.sub_scores?.keywords||0)}</div>
          </div>
          <div style="margin-top:8px;"><b>ç¼ºå£å…³é”®è¯ï¼š</b>${pillList(ats.gap_keywords||[])}</div>
          <div style="margin-top:8px;"><b>ä¼˜åŒ–å»ºè®®ï¼š</b><ul>${(ats.improvement_advice||[]).map(li => `<li>${escapeHtml(li)}</li>`).join("")}</ul></div>
        `;
      }else{
        atsHtml = `<div class="muted">æœªæä¾› JDï¼Œæœªè¿›è¡Œ ATS è¯„åˆ†ã€‚</div>`;
      }

      const sal = d.salary_insights || {};
      const salary = `
        <div><b>${escapeHtml(sal.city||"-")} Â· ${escapeHtml(sal.title||"-")}</b></div>
        <div style="margin:6px 0;">
          <div class="muted">ä½ä½</div>${scoreBar(scaleSalary(sal.low, sal.high, sal.low))}
          <div class="muted">ä¸­ä½</div>${scoreBar(scaleSalary(sal.mid, sal.high, sal.low))}
          <div class="muted">é«˜ä½</div>${scoreBar(100)}
        </div>
        <div class="muted">${escapeHtml(sal.notes||"æ¨¡å‹ä¼°ç®—ï¼Œä¾›å‚è€ƒ")}</div>
      `;

      let html = "";
      html += card("ğŸ“Œ æ¦‚è§ˆ", overview);
      html += card("ğŸ“ ç®€å†æ‘˜è¦", summary);
      html += card("ğŸŒŸ èŒä¸šäº®ç‚¹", highlights || "<div class='muted'>æ— </div>");
      html += card("ğŸ”‘ æ ¸å¿ƒå…³é”®è¯", keywords   || "<div class='muted'>æ— </div>");
      html += card("ğŸ“ˆ æ±‚èŒæ–¹å‘", career);
      html += card("ğŸ“Š ATS åŒ¹é…", atsHtml);
      html += card("ğŸ’¬ é¢è¯•è¾…å¯¼", interview);
      html += card("ğŸ’° è–ªé…¬ä¼°ç®—", salary);

      feed.innerHTML = html;

      // ç¼“å­˜
      localStorage.setItem(cacheKey, JSON.stringify(data));
      showBannerCache();
    }

    function scaleSalary(v, max, min){
      const high = Number(max||0), low = Number(min||0), val = Number(v||0);
      if (high <= 0){ return 0; }
      if (val <= low){ return 5; }
      return Math.max(5, Math.min(100, Math.round((val - low) / (high - low + 1) * 100)));
    }

    function showError(msg){
      alertArea.innerHTML = `<div class="error">${escapeHtml(msg||"å‡ºé”™äº†")}</div>`;
    }

    function escapeHtml(str){
      return (str||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // äº‹ä»¶ç»‘å®š
    $("#resumeFile").addEventListener("change", async (e)=>{
      const f = e.target.files[0];
      if (!f) return;
      const fd = new FormData();
      fd.append("file", f);
      const res = await fetch("/extract-text",{method:"POST", body:fd});
      const j = await res.json();
      if (!j.ok){ showError(j.error||"æ–‡ä»¶è§£æå¤±è´¥"); return; }
      $("#resumeText").value = j.text||"";
    });

    $("#btnClear").addEventListener("click", ()=>{
      $("#resumeText").value = "";
      $("#targetTitle").value = "";
      $("#targetLocation").value = "";
      $("#targetIndustry").value = "";
      $("#jobDescription").value = "";
    });

    $("#btnGenerate").addEventListener("click", async ()=>{
      const resume_text = $("#resumeText").value.trim();
      const job_description = $("#jobDescription").value.trim();
      const target_title = $("#targetTitle").value.trim();
      const target_location = $("#targetLocation").value.trim();
      const target_industry = $("#targetIndustry").value.trim();

      if (!resume_text){
        showError("è¯·ç²˜è´´ç®€å†æ–‡æœ¬æˆ–ä¸Šä¼ æ–‡ä»¶");
        return;
      }
      if (resume_text.length < 500 && (resume_text.match(/[A-Za-z]+/g)||[]).length < 300){
        showError("ç®€å†æ–‡æœ¬è¿‡çŸ­ï¼ˆâ‰¥500 ä¸­æ–‡å­—ç¬¦æˆ– â‰¥300 è‹±æ–‡è¯ï¼‰");
        return;
      }
      if (resume_text.length > 18000){
        showError("ç®€å†æ–‡æœ¬è¿‡é•¿ï¼ˆâ‰¤ 18,000 å­—ç¬¦ï¼‰");
        return;
      }
      if (job_description.length > 10000){
        showError("JD æ–‡æœ¬è¿‡é•¿ï¼ˆâ‰¤ 10,000 å­—ç¬¦ï¼‰");
        return;
      }

      skeleton();
      try{
        const resp = await fetch("/optimize",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({
            resume_text, job_description,
            target_title, target_location, target_industry
          })
        });
        const j = await resp.json();
        if(!j.ok){ showError(j.error||"ç”Ÿæˆå¤±è´¥"); return; }
        renderReport(j);
      }catch(err){
        showError("ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨è¶…æ—¶");
      }
    });

    $("#btnClearCache").addEventListener("click",(e)=>{
      e.preventDefault();
      localStorage.removeItem(cacheKey);
      showBannerCache();
    });

    // é¦–æ¬¡åŠ è½½ï¼šæ¢å¤ç¼“å­˜
    (function(){
      try{
        const cache = localStorage.getItem(cacheKey);
        if(cache){
          const j = JSON.parse(cache);
          renderReport(j);
        }
      }catch(e){}
      showBannerCache();
    })();
  </script>
</body>
</html>
