<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Alsos AI Resume Â· æ±‚èŒåŠ©æ‰‹</title>
<style>
  :root{--bg:#F3F2EF;--card:#fff;--text:#111827;--muted:#6B7280;--border:#E5E7EB;
        --brand:#0D3B2E;--brand-weak:#E7F0ED;--warn:#fffbe6;--warn-b:#f5e79f}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,sans-serif}
  .topbar{height:56px;background:var(--card);border-bottom:1px solid var(--border);
          display:flex;align-items:center;justify-content:space-between;padding:0 16px;position:sticky;top:0;z-index:10}
  .brand{font-weight:800;color:var(--brand)} .hint{color:var(--muted);font-size:12px}

  .container{max-width:1100px;margin:16px auto;padding:0 12px;
             display:grid;grid-template-columns:360px 1fr;gap:16px;align-items:start}
  @media (max-width:980px){.container{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .title{padding:12px 16px;font-weight:700;color:var(--brand);border-bottom:1px solid var(--border)}
  .content{padding:14px 16px;line-height:1.65}
  .section-title{padding:14px 16px;font-weight:700;border-bottom:1px solid var(--border);color:var(--brand)}
  .body{padding:14px 16px}

  .row{display:flex;gap:10px;margin-bottom:10px}
  input[type=text],textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#FAFAFA;outline:none}
  textarea{min-height:140px;resize:vertical}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:1px solid transparent;cursor:pointer;transition:all .15s ease}
  .btn-primary{background:var(--brand);color:#fff}.btn-primary:hover{opacity:.9}
  .btn-ghost{background:#EEF2F3;color:var(--brand);border-color:#DDE4E6}.btn-ghost:hover{background:#E7ECEE}
  .btn-danger{background:#fee2e2;color:#991b1b;border-color:#fecaca}

  .pill{display:inline-block;padding:4px 8px;background:var(--brand-weak);border-radius:999px;margin:0 6px 6px 0}
  .muted{color:var(--muted);font-size:12px}
  .banner{background:var(--warn);border:1px solid var(--warn-b);color:#8b6a00;padding:8px 12px;border-radius:10px;margin-bottom:12px;font-size:13px}

  .progress-wrap{background:#EEF2F3;border:1px solid var(--border);border-radius:10px;overflow:hidden;height:16px}
  .progress-bar{height:100%;background:linear-gradient(90deg,var(--brand),#178066);width:0%;color:#fff;font-size:12px;
    display:flex;align-items:center;justify-content:center;transition:width .3s ease}
  .progress-text{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}

  .skeleton{background:linear-gradient(90deg,#f3f4f6,#e5e7eb,#f3f4f6);background-size:200% 100%;animation:s 1.2s linear infinite;border-radius:8px;height:14px;margin:6px 0}
  @keyframes s{0%{background-position:200% 0}100%{background-position:-200% 0}}

  .error{background:#fff1f2;border:1px solid #fecdd3;color:#7f1d1d;border-radius:8px;padding:8px 10px}

  .right{grid-column:2 / -1; display:flex; flex-direction:column; gap:16px; align-items:stretch}
  .progress-card{margin-bottom:0}
  #feed{display:flex; flex-direction:column; gap:16px}

  /* è–ªé…¬æ¡å½¢ï¼šå›ºå®šå®¹å™¨å®½åº¦ï¼Œå†…éƒ¨ width ç”¨ç™¾åˆ†æ¯” */
  .bar-row{display:flex;gap:10px;align-items:center;margin:6px 0}
  .bar-box{flex:1;height:12px;background:#EEF2F3;border:1px solid #E5E7EB;border-radius:999px;overflow:hidden}
  .bar-inner{height:100%;background:#0D3B2E;width:0%}
  .bar-text{width:64px;text-align:right;font-size:12px;color:#374151}
  /* æ‰“å­—æœºæ•ˆæœ */
  .tw{white-space:pre-wrap}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Alsos AI Resume</div>
    <div class="hint">é»˜è®¤æ€è€ƒæ¨¡å¼ï¼ˆå†…å®¹æ›´æ·±å…¥ï¼‰</div>
  </div>

  <div class="container">
    <!-- å·¦åˆ— -->
    <div class="card">
      <div class="section-title">è¾“å…¥åŒº</div>
      <div class="body">
        <div class="row"><input type="file" id="resumeFile" accept=".txt,.docx"/></div>
        <div class="row"><textarea id="resumeText" placeholder="ç²˜è´´ç®€å†ï¼ˆä¸­/è‹±ï¼‰æˆ–ä¸Šä¼  .txt/.docx"></textarea></div>
        <div class="row"><input id="targetTitle" type="text" placeholder="ç›®æ ‡èŒä½"/></div>
        <div class="row"><input id="targetLocation" type="text" placeholder="æœŸæœ›åœ°ç‚¹"/></div>
        <div class="row"><input id="targetIndustry" type="text" placeholder="ç›®æ ‡è¡Œä¸šï¼ˆå¯é€‰ï¼‰"/></div>
        <div class="row"><textarea id="jobDescription" placeholder="ç›®æ ‡èŒä½ JDï¼ˆå¯é€‰ï¼Œç”¨äº ATSä¸æ•™è‚²è¦æ±‚è¯†åˆ«ï¼‰"></textarea></div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" id="btnGenerate">ä¸€é”®ç”Ÿæˆï¼ˆæ€è€ƒï¼‰</button>
          <button class="btn btn-ghost" id="btnBalanced">å¹³è¡¡æ¨¡å¼ï¼ˆæé€Ÿï¼‰</button>
          <button class="btn btn-ghost" id="btnGenerateFast">æé€Ÿæ¨¡å¼ï¼ˆè¾ƒå¿«ï¼‰</button>
          <button class="btn btn-danger" id="btnCancel" style="display:none">å–æ¶ˆç”Ÿæˆ</button>
        </div>
        <div class="muted">æ¨¡å—ä¼šé™†ç»­å‡ºç°ï¼›æ‰“å­—æœºé€å­—å‘ˆç°ï¼Œç­‰å€™æ›´å‹å¥½ã€‚</div>
      </div>
    </div>

    <!-- å³åˆ— -->
    <div class="right">
      <div class="card progress-card">
        <div class="section-title">æ­£åœ¨åˆ†æç®€å†</div>
        <div class="content">
          <div class="progress-wrap"><div class="progress-bar" id="pgbar">0%</div></div>
          <div class="progress-text" id="pgtext">è«ç€æ€¥ã€è«ç€æ€¥ï¼Œä½ çš„ç®€å†å¾ˆç²¾å½©ï¼Œå®¹æˆ‘è®¤çœŸæ‹œè¯»ï½</div>
        </div>
      </div>
      <div id="feed"></div>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const feed = $("#feed");
let controller = null, watchdog = null, progressTimer = null;
let baseProgress = 0, sectionsDone = 0, sectionsTotal = 8;

const SECTION_TITLES = {
  "summary_highlights":"ğŸ“Œ æ¦‚è§ˆ / äº®ç‚¹",
  "improvements":"ğŸ› ï¸ ç®€æ´ç‰ˆç®€å†ä¼˜åŒ–ï¼ˆTop 6ï¼‰",
  "career_diagnosis":"ğŸ§­ èŒä¸šè½¨è¿¹è¯Šæ–­ï¼ˆä»…å‘½ä¸­é¡¹ï¼‰",
  "career_level":"ğŸ·ï¸ Level åˆ¤å®šä¸è·¯å¾„ï¼ˆç²¾ç®€ï¼‰",
  "personalized_strategy":"ğŸ“ˆ æ±‚èŒç­–ç•¥ï¼ˆä¸ªæ€§åŒ–ã€çŸ­ä¸­é•¿ï¼‰",
  "interview":"ğŸ“– é¢è¯•æ‰‹å†Œï¼ˆå¯¹åº”çº§åˆ«ï¼‰",
  "salary":"ğŸ’° è–ªé…¬ä¼°ç®—ï¼ˆæ¨¡å‹å‚è€ƒï¼‰",
  "ats":"ğŸ“Š ATS åŒ¹é…"
};

function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function card(id, title, inner=""){const el=document.createElement("div");el.className="card";el.id=id;el.innerHTML=`<div class="title">${title}</div><div class="content">${inner}</div>`;feed.appendChild(el);return el.querySelector(".content");}
function ensureSkeleton(section){const id=`sec-${section}`;if(document.getElementById(id))return;card(id,SECTION_TITLES[section]||section,`<div class="skeleton" style="width:70%"></div><div class="skeleton" style="width:88%"></div><div class="skeleton" style="width:60%"></div>`);}
function showError(section,msg){const id=`sec-${section}`;const el=document.getElementById(id) || card(id,SECTION_TITLES[section]||section);el.innerHTML=`<div class="error">âš ï¸ ${escapeHtml(msg||"æœªçŸ¥é”™è¯¯")}</div>`;}

function updateProgress(real=false){
  if(!real){baseProgress=Math.min(80,baseProgress+(Math.random()*1.5+0.5));}
  const logical=Math.floor((sectionsDone/Math.max(1,sectionsTotal))*100);
  const pct=Math.max(Math.min(100,logical),Math.floor(baseProgress));
  const bar=$("#pgbar"); bar.style.width=pct+"%"; bar.textContent=pct+"%";
}

/* ---------- æ‰“å­—æœº ---------- */
function typeWrite(el, text, speed=8){ // æ¯å­—ç¬¦ 8msï¼Œä¸­æ–‡ä¹ŸOK
  text = String(text||"");
  el.classList.add("tw");
  el.textContent="";
  let i=0;
  return new Promise(resolve=>{
    const timer=setInterval(()=>{
      el.textContent += text[i]||"";
      i++; if(i>=text.length){clearInterval(timer);resolve();}
    }, speed);
  });
}
async function typeList(el, arr){
  el.innerHTML = "<ul></ul>";
  const ul = el.querySelector("ul");
  for (const item of (arr||[])){
    const li=document.createElement("li");
    ul.appendChild(li);
    await typeWrite(li, item, 8);
  }
}

/* ---------- æ¸²æŸ“ ---------- */
async function renderPiece(section, data){
  const id=`sec-${section}`;let el=document.getElementById(id)?.querySelector(".content");
  if(!el){ el=card(id,SECTION_TITLES[section]||section); }
  if(!data || Object.keys(data).length===0){ el.innerHTML=`<div class="skeleton" style="width:85%"></div>`; return; }

  if(section==="summary_highlights"){
    const s=data.summary||"", hl=data.highlights||[];
    el.innerHTML=`<div class="banner">å¼•æ“ï¼šAlsos AI Resume</div><p id="sum"></p><div id="hl"></div>`;
    await typeWrite(el.querySelector("#sum"), s);
    await typeList(el.querySelector("#hl"), hl);

  } else if(section==="improvements"){
    const arr=data.resume_improvements||[];
    el.innerHTML = arr.length? arr.map((it,i)=>`<div style="margin-bottom:10px">
      <div><b>${i+1}. é—®é¢˜ï¼š</b><span id="i${i}_a"></span></div>
      <div><b>æ–¹æ¡ˆï¼š</b><span id="i${i}_b"></span></div>
      <div class="muted"><b>åŸå› ï¼š</b><span id="i${i}_c"></span></div></div>`).join("") : "<div class='muted'>æš‚æ— </div>";
    for(let i=0;i<arr.length;i++){
      await typeWrite(el.querySelector(`#i${i}_a`), arr[i].issue||"");
      await typeWrite(el.querySelector(`#i${i}_b`), arr[i].fix||"");
      await typeWrite(el.querySelector(`#i${i}_c`), arr[i].why||"");
    }

  } else if(section==="career_diagnosis"){
    const items=(data.career_diagnosis||[]);
    el.innerHTML = items.length? items.map((it,i)=>`<div style="margin-bottom:10px">
      <div><b>${i+1}. å‘ç°ï¼š</b><span id="d${i}_a"></span></div>
      <div><b>é£é™©ï¼š</b><span id="d${i}_b"></span></div>
      <div class="muted"><b>å»ºè®®ï¼š</b><span id="d${i}_c"></span></div></div>`).join("") : "<div class='muted'>æœªå‘½ä¸­ä»»ä½•é£é™©é¡¹ï¼ˆè¿™å¾ˆå¥½ï¼‰ã€‚</div>";
    for(let i=0;i<items.length;i++){
      await typeWrite(el.querySelector(`#d${i}_a`), items[i].issue||"");
      await typeWrite(el.querySelector(`#d${i}_b`), items[i].risk||"");
      await typeWrite(el.querySelector(`#d${i}_c`), items[i].advice||"");
    }

  } else if(section==="career_level"){
    const a=data.career_level_analysis||{}, f=a.interview_focus||{};
    el.innerHTML=`<div><b>åˆ¤å®š Levelï¼š</b><span id="lv"></span> <span class="muted">ï¼ˆç†ç”±ï¼š<span id="lv_r"></span>ï¼‰</span></div>
    <div style="margin-top:8px"><b>å‘å±•è·¯å¾„å»ºè®®ï¼š</b><div id="path"></div></div>
    <div style="margin-top:8px"><b>ä¸åŒ Level é¢è¯•å…³æ³¨ç‚¹ï¼š</b>
      <div><i>Junior</i><div id="f_j"></div></div>
      <div><i>Middle</i><div id="f_m"></div></div>
      <div><i>Senior</i><div id="f_s"></div></div>
      <div><i>Executive</i><div id="f_e"></div></div>
    </div>`;
    await typeWrite(el.querySelector("#lv"), a.level||"-");
    await typeWrite(el.querySelector("#lv_r"), a.reason||"-");
    await typeList(el.querySelector("#path"), a.path||[]);
    await typeList(el.querySelector("#f_j"), f.junior||[]);
    await typeList(el.querySelector("#f_m"), f.middle||[]);
    await typeList(el.querySelector("#f_s"), f.senior||[]);
    await typeList(el.querySelector("#f_e"), f.executive||[]);

  } else if(section==="personalized_strategy"){
    const st=data.strategy||{};
    el.innerHTML=`<div class="muted"><span id="ass"></span></div>
    <div style="margin-top:8px"><b>çŸ­æœŸï¼ˆ3-6ä¸ªæœˆï¼‰ï¼š</b><div id="st_s"></div></div>
    <div><b>ä¸­æœŸï¼ˆ6-18ä¸ªæœˆï¼‰ï¼š</b><div id="st_m"></div></div>
    <div><b>é•¿æœŸï¼ˆ18ä¸ªæœˆ+ï¼‰ï¼š</b><div id="st_l"></div></div>
    ${(st.if_job_hopping&&st.if_job_hopping.length)?`<div><b>è·³æ§½é¢‘ç¹ä¸“é¡¹ï¼š</b><div id="st_h"></div></div>`:""}`;
    await typeWrite(el.querySelector("#ass"), st.assumptions||"");
    await typeList(el.querySelector("#st_s"), st.short_term||[]);
    await typeList(el.querySelector("#st_m"), st.mid_term||[]);
    await typeList(el.querySelector("#st_l"), st.long_term||[]);
    if(st.if_job_hopping) await typeList(el.querySelector("#st_h"), st.if_job_hopping||[]);

  } else if(section==="interview"){
    const ih=data.interview_handbook||{};
    el.innerHTML=`<div><b>å›ç­”é€»è¾‘ï¼š</b><div id="ans"></div></div>
    <div style="margin-top:4px"><b>ä¸åŒé¢è¯•å®˜å…³æ³¨ç‚¹ï¼š</b>
      <div><i>HR</i><div id="fh"></div></div>
      <div><i>éƒ¨é—¨è´Ÿè´£äºº</i><div id="fm"></div></div>
      <div><i>è€æ¿/é«˜å±‚</i><div id="fe"></div></div>
    </div>
    <div style="margin-top:4px"><b>STAR é¡¹ç›®ç­”é¢˜æç¤ºï¼ˆ3 å¥—ï¼‰ï¼š</b><ol id="stars"></ol></div>
    <div><b>é£é™©ç‚¹åº”å¯¹ï¼š</b><div id="risk"></div></div>`;
    await typeList(el.querySelector("#ans"), ih.answer_logic||[]);
    await typeList(el.querySelector("#fh"), ih.interviewer_focus?.HR||[]);
    await typeList(el.querySelector("#fm"), ih.interviewer_focus?.hiring_manager||[]);
    await typeList(el.querySelector("#fe"), ih.interviewer_focus?.executive||[]);
    // stars
    const stars = ih.star_sets||[];
    const ol = el.querySelector("#stars");
    for(const s of stars){
      const li=document.createElement("li");
      li.innerHTML = `<b>${escapeHtml(s.project_title||"é¡¹ç›®")}</b> Â· ${escapeHtml(s.question||"")}<ul></ul>`;
      ol.appendChild(li);
      await typeList(li.querySelector("ul"), s.how_to_answer||[]);
    }
    await typeList(el.querySelector("#risk"), ih.risk_mitigation||[]);

  } else if(section==="ats"){
    const ats=data.ats||{};
    if(!ats.enabled){ el.innerHTML="<div class='muted'>æœªæä¾› JDï¼Œæœªè¿›è¡Œ ATS è¯„åˆ†ã€‚</div>"; return; }
    el.innerHTML=`<div><b>æ€»åˆ†ï¼š</b>
      <div class="bar-row"><div class="bar-box"><div class="bar-inner" id="b0"></div></div><span class="bar-text" id="t0"></span></div></div>
      <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:8px;">
        <div><b>æŠ€èƒ½</b><div class="bar-row"><div class="bar-box"><div class="bar-inner" id="b1"></div></div><span class="bar-text" id="t1"></span></div><div class="muted">${(ats.reasons?.skills||[]).join(" Â· ")}</div></div>
        <div><b>ç»éªŒ</b><div class="bar-row"><div class="bar-box"><div class="bar-inner" id="b2"></div></div><span class="bar-text" id="t2"></span></div><div class="muted">${(ats.reasons?.experience||[]).join(" Â· ")}</div></div>
        <div><b>æ•™è‚²</b><div class="bar-row"><div class="bar-box"><div class="bar-inner" id="b3"></div></div><span class="bar-text" id="t3"></span></div><div class="muted">${(ats.reasons?.education||[]).join(" Â· ")}</div></div>
        <div><b>å…³é”®è¯</b><div class="bar-row"><div class="bar-box"><div class="bar-inner" id="b4"></div></div><span class="bar-text" id="t4"></span></div><div class="muted">${(ats.reasons?.keywords||[]).join(" Â· ")}</div></div>
      </div>
      <div style="margin-top:8px;"><b>ç¼ºå£å…³é”®è¯ï¼š</b>${(ats.gap_keywords||[]).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join("")}</div>
      <div style="margin-top:8px;"><b>ä¼˜åŒ–å»ºè®®ï¼š</b><div id="advs"></div></div>`;
    const nums=[ats.total_score||0, ats.sub_scores?.skills||0, ats.sub_scores?.experience||0, ats.sub_scores?.education||0, ats.sub_scores?.keywords||0];
    nums.forEach((n,i)=>{const x=Math.max(0,Math.min(100,Number(n))); el.querySelector("#t"+i).textContent = `${x}/100`; el.querySelector("#b"+i).style.width = x+"%";});
    await typeList(el.querySelector("#advs"), ats.improvement_advice||[]);

  } else if(section==="salary"){
    const s=data.salary_insights||{};
    const pct = (v,lo,hi)=>{ if(!hi||hi<=lo) return 0; return Math.round(((v-lo)/(hi-lo))*100); };
    el.innerHTML=`<div class="muted">${escapeHtml(s.title||"")} Â· ${escapeHtml(s.city||"")} Â· ${escapeHtml(s.currency||"")}</div>
      <div class="bar-row"><div class="bar-box"><div class="bar-inner" id="sl"></div></div><span class="bar-text">${s.low||0}</span></div>
      <div class="bar-row"><div class="bar-box"><div class="bar-inner" id="sm"></div></div><span class="bar-text">${s.mid||0}</span></div>
      <div class="bar-row"><div class="bar-box"><div class="bar-inner" id="sh"></div></div><span class="bar-text">${s.high||0}</span></div>
      <div style="margin-top:8px;"><b>å½±å“å› å­ï¼š</b><div id="sf"></div></div>
      <div class="muted" style="margin-top:4px;">${escapeHtml(s.notes||"æ¨¡å‹ä¼°ç®—ï¼Œä¾›å‚è€ƒ")}</div>`;
    const lo=Number(s.low||0), mi=Number(s.mid||0), hi=Number(s.high||0);
    el.querySelector("#sl").style.width = "5%"; // ä½æ¡£ä»…ä½œä½ç½®å‚è€ƒ
    el.querySelector("#sm").style.width = (hi>lo? pct(mi,lo,hi):50)+"%";
    el.querySelector("#sh").style.width = "100%";
    await typeList(el.querySelector("#sf"), s.factors||[]);

  } else {
    if(data && data._raw_preview){
      el.innerHTML=`<div class="error">âš ï¸ è¯¥æ¨¡å—è¿”å›ç»“æ„ä¸å®Œæ•´ï¼Œå·²é™çº§å±•ç¤ºåŸæ–‡ç‰‡æ®µï¼š</div><pre style="white-space:pre-wrap">${escapeHtml(data._raw_preview)}</pre>`;
    }else{
      el.innerHTML=`<div class="muted">å·²æ”¶åˆ°å†…å®¹ï¼Œä½†ç»“æ„è¾ƒç©ºï¼ŒåŸå§‹æ•°æ®ï¼š</div><pre style="white-space:pre-wrap">${escapeHtml(JSON.stringify(data||{},null,2))}</pre>`;
    }
  }
}

/* ---------- æµ/æ§åˆ¶ ---------- */
function armWatchdog(mode){
  clearTimeout(watchdog);
  watchdog=setTimeout(()=>{
    const tip=document.createElement("div"); tip.className="card";
    tip.innerHTML=`<div class="title">â³ æ­£åœ¨åŠªåŠ›ç”Ÿæˆ</div><div class="content">
      <div class="muted">æ€è€ƒæ¨¡å¼åœ¨é•¿æ–‡æ¡£ä¸‹ä¼šæ…¢ä¸€äº›ã€‚ä½ å¯ä»¥ç»§ç»­ç­‰ï¼Œæˆ–è¯•è¯•â€œå¹³è¡¡/æé€Ÿæ¨¡å¼â€ã€‚</div>
      <div style="margin-top:8px"><button class="btn btn-ghost" id="retryFast">åˆ‡æ¢æé€Ÿæ¨¡å¼é‡è¯•</button></div></div>`;
    feed.prepend(tip); $("#retryFast").onclick=()=>{ cancelStream(); startStream("speed"); };
  }, 90000);
}

async function startStream(mode="depth"){
  feed.innerHTML=""; sectionsDone=0; baseProgress=0; sectionsTotal=8; updateProgress(true);
  $("#btnCancel").style.display="inline-flex";
  ["career_diagnosis","improvements","summary_highlights","career_level","personalized_strategy","interview","salary","ats"].forEach(ensureSkeleton);
  clearInterval(progressTimer); progressTimer=setInterval(()=>updateProgress(false),800);
  controller=new AbortController(); armWatchdog(mode);

  const body={
    resume_text: $("#resumeText").value.trim(),
    job_description: $("#jobDescription").value.trim(),
    target_title: $("#targetTitle").value.trim(),
    target_location: $("#targetLocation").value.trim(),
    target_industry: $("#targetIndustry").value.trim(),
    model: mode
  };
  if(!body.resume_text){ alert("è¯·ç²˜è´´ç®€å†æ–‡æœ¬æˆ–ä¸Šä¼ æ–‡ä»¶"); cancelStream(); return; }

  const res=await fetch("/optimize_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body),signal:controller.signal});
  if(!res.ok){ cancelStream(); feed.innerHTML=`<div class="card"><div class="title">æœåŠ¡å¼‚å¸¸</div><div class="content">è¯·ç¨åå†è¯•</div></div>`; return; }

  const decoder=new TextDecoder("utf-8"); const reader=res.body.getReader(); let buf="";
  while(true){
    const {value,done}=await reader.read(); if(done) break;
    clearTimeout(watchdog); armWatchdog(mode);
    buf += decoder.decode(value,{stream:true});
    const parts=buf.split("\n\n");
    for(let i=0;i<parts.length-1;i++){
      const line=parts[i].trim(); if(!line||line.startsWith(":")||!line.startsWith("data:")) continue;
      try{
        const payload=JSON.parse(line.slice(5).trim());
        if(payload.section==="boot"){
          const tip=document.createElement("div"); tip.className="card";
          tip.innerHTML=`<div class="title">å¼•æ“å·²å¯åŠ¨</div><div class="content"><div class="muted">${escapeHtml(payload.data.msg||"æ­£åœ¨å‡†å¤‡â€¦")}</div></div>`;
          feed.prepend(tip); continue;
        }
        if(payload.section==="done"){
          if(payload.data && payload.data.meta && typeof payload.data.meta.has_jd==="boolean"){
            sectionsTotal = payload.data.meta.has_jd ? 8 : 7;
          }
          sectionsDone = sectionsTotal; updateProgress(true); continue;
        }
        if(payload.error){ showError(payload.section,payload.error); }
        else{ await renderPiece(payload.section,payload.data); }
        sectionsDone++; updateProgress(true);
      }catch(e){}
    }
    buf = parts[parts.length-1];
  }
  cancelStream();
}

function cancelStream(){ if(controller){controller.abort();controller=null;} clearInterval(progressTimer); clearTimeout(watchdog); $("#btnCancel").style.display="none"; const bar=$("#pgbar"); bar.style.width="100%"; bar.textContent="100%"; }

$("#btnGenerate").addEventListener("click", ()=>startStream("depth"));
$("#btnBalanced").addEventListener("click", ()=>startStream("balanced"));
$("#btnGenerateFast").addEventListener("click", ()=>startStream("speed"));
$("#btnCancel").addEventListener("click", cancelStream);
$("#resumeFile").addEventListener("change", async (e)=>{const f=e.target.files[0]; if(!f) return; const fd=new FormData(); fd.append("file",f); const r=await fetch("/extract-text",{method:"POST",body:fd}); const j=await r.json(); if(j.ok) $("#resumeText").value=j.text||"";});
</script>
</body>
</html>
