<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alsos NeuroMatch · 求职助手</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
    --accent:#22d3ee; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    --border:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 16px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:1fr 1fr}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
  label{display:block;margin:8px 0 6px;color:#cbd5e1}
  textarea,input,select{
    width:100%;color:var(--text);background:#0b1220;border:1px solid var(--border);
    border-radius:10px;padding:10px 12px;outline:none
  }
  textarea{min-height:130px;resize:vertical}
  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{
    background:#111827;border:1px solid var(--border);color:var(--text);
    border-radius:10px;padding:10px 14px;cursor:pointer
  }
  button.primary{background:var(--accent);color:#001018;border:0}
  .bar{height:6px;background:#0b1220;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin:8px 0 6px}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#22d3ee,#14b8a6)}
  .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .sec h3{margin:0 0 8px;font-size:16px}
  .klist{margin:0;padding-left:18px}
  .kbadge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0b1220;border:1px solid var(--border);margin:3px 6px 0 0;color:#cbd5e1}
  details{margin-top:8px}
  pre{white-space:pre-wrap;background:#0b1220;border:1px solid var(--border);border-radius:10px;padding:10px}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Alsos NeuroMatch · 求职助手</h1>

  <div class="card">
    <div class="grid g2">
      <div>
        <label>① 粘贴你的简历文本（支持中文）</label>
        <textarea id="resume" placeholder="粘贴 Word/PDF 里的纯文本…"></textarea>
      </div>
      <div>
        <div class="grid">
          <div>
            <label>目标职位</label>
            <input id="title" placeholder="如：资深产品经理 / 财务总监"/>
          </div>
          <div>
            <label>期望地点</label>
            <input id="city" placeholder="如：上海 / 深圳"/>
          </div>
          <div>
            <label>目标行业（可选）</label>
            <input id="industry" placeholder="如：互联网 / 医疗 / 制造"/>
          </div>
        </div>
        <label style="margin-top:8px">目标职位 JD（可选，用于 ATS 评分）</label>
        <textarea id="jd" placeholder="粘贴 JD 原文；留空则不做 ATS 评分"></textarea>
      </div>
    </div>

    <div class="btns">
      <button class="primary" onclick="runFull()">一键生成报告</button>
      <button onclick="exportPDF()">导出 PDF</button>
      <button onclick="exportDOCX()">导出 DOCX</button>
    </div>
    <div class="bar"><i id="pbar"></i></div>
    <div class="muted">提示：首次生成可能较慢（冷启动 + LLM 计算），属正常。</div>
  </div>

  <div id="out" class="grid" style="margin-top:12px;gap:12px"></div>
</div>

<script>
/* ====== 小工具 ====== */
function setBar(v){ document.getElementById('pbar').style.width = Math.max(0,Math.min(100,v)) + '%'; }
const esc = s => (s||"").toString().replace(/[&<>"]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]));
const li = s => `<li>${esc(s)}</li>`;
const list = arr => `<ul class="klist">${(arr||[]).map(x=>li(typeof x==='string'?x:JSON.stringify(x))).join('')}</ul>`;
const badges = arr => `<div>${(arr||[]).map(x=>`<span class="kbadge">${esc(x)}</span>`).join('')}</div>`;
const jsonBox = (obj,label="查看原始 JSON") => `<details><summary>${label}</summary><pre>${esc(JSON.stringify(obj,null,2))}</pre></details>`;

/* ====== 渲染报告 ====== */
function renderReport(data){
  const box = document.getElementById('out');
  const R = data.resume_optimization || {};
  const I = data.interview || {};
  const C = data.career_plan || {};
  const hasATS = !!data.ats;

  const card1 = `
  <div class="card sec">
    <h3>报告 · 简历优化</h3>
    <div class="cols">
      <div>
        <div class="muted">建议增加的要点</div>${list(R.bullets_to_add)}
        <div class="muted" style="margin-top:8px">建议压缩/改写</div>${list(R.bullets_to_tighten)}
        <div class="muted" style="margin-top:8px">推荐板块顺序</div>${badges(R.section_order)}
      </div>
      <div>
        <div class="muted">核心技能关键词</div>${badges(R.skills_keywords_core)}
        <div class="muted" style="margin-top:8px">中文简介</div><pre>${esc(R.summary_cn)}</pre>
        <div class="muted" style="margin-top:8px">英文简介</div><pre>${esc(R.summary_en)}</pre>
      </div>
    </div>
    ${jsonBox(R)}
  </div>`;

  const card2 = `
  <div class="card sec">
    <h3>报告 · 面试问答</h3>
    <div class="cols">
      <div>
        <div class="muted">高频问题</div>${list(I.top_questions)}
      </div>
      <div>
        <div class="muted">面试提示</div>${list(I.tips)}
        <div class="muted" style="margin-top:8px">训练/作业</div>${list(I.drills)}
      </div>
    </div>
    ${jsonBox(I)}
  </div>`;

  const card3 = `
  <div class="card sec">
    <h3>报告 · 职业建议（3-5年）</h3>
    ${(C.career_paths||[]).map(p=>`
      <div style="margin-bottom:10px;padding-bottom:10px;border-bottom:1px dashed var(--border)">
        <div class="muted">方向</div><pre>${esc(p.title||'')}</pre>
        <div class="muted">Why now</div><pre>${esc(p.why_now||'')}</pre>
        <div class="muted">90 天行动</div>${list(p.90_day_plan||p['90_day_plan']||[])}
        <div class="muted">需补齐的能力/经验</div>${list(p.gap_to_fill||[])}
        <div class="muted">要建立的人脉</div>${list(p.network_to_build||[])}
        <div class="muted">要学习的技能</div>${list(p.skills_to_learn||[])}
      </div>
    `).join('')}
    ${jsonBox(C)}
  </div>`;

  const card4 = hasATS ? `
  <div class="card sec">
    <h3>报告 · ATS 匹配（若提供 JD）</h3>
    <div class="muted">ATS 评分</div><div style="font-size:22px;color:var(--ok);font-weight:600">${esc(data.ats.score)} / 100</div>
    <div class="muted" style="margin-top:8px">亮点</div>${list(data.ats.highlights||[])}
    <div class="muted" style="margin-top:8px">关键词建议</div>${badges(data.ats.keywords||[])}
    <div class="muted" style="margin-top:8px">不匹配/补救</div>${list(data.ats.mismatch||[])}
    ${jsonBox(data.ats)}
  </div>` : '';

  box.innerHTML = card1 + card2 + card3 + card4;
}

/* ====== 生成报告（含重试 & 解析原文） ====== */
async function runFull(){
  try{
    setBar(8);
    const payload = {
      resume_text:    (document.getElementById('resume')||{}).value || '',
      target_title:   (document.getElementById('title')||{}).value  || '',
      target_city:    (document.getElementById('city')||{}).value   || '',
      target_industry:(document.getElementById('industry')||{}).value||'',
      jd_text:        (document.getElementById('jd')||{}).value     || ''
    };

    const doFetch = async () => {
      const res = await fetch('/full_report', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload),
        credentials:'same-origin',
        cache:'no-store'
      });
      const raw = await res.text();
      if(!res.ok) throw new Error(`HTTP ${res.status} — ${raw.slice(0,500)}`);
      try{
        return JSON.parse(raw);
      }catch(e){
        throw new Error(`服务端返回的不是有效 JSON：${e.message}\n片段：${raw.slice(0,500)}`);
      }
    };

    setBar(20);
    let data;
    try{
      data = await doFetch();
    }catch(e1){
      console.warn('第一次失败，重试一次：', e1);
      await new Promise(r=>setTimeout(r,1500));
      data = await doFetch();
    }
    setBar(85);
    renderReport(data);
    setBar(100);
  }catch(err){
    alert(`生成失败： ${err.message||err}`);
    setBar(0);
  }
}

/* ====== 导出（占位：你后面接入 html2pdf/docx 即可） ====== */
function exportPDF(){ alert('PDF 导出占位：后续接入 html2pdf.js 即可。'); }
function exportDOCX(){ alert('DOCX 导出占位：后续接入 docx 库或后端生成。'); }
</script>
</body>
</html>
