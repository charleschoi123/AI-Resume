<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Alsos AI Resume Â· æ±‚èŒåŠ©æ‰‹</title>
<style>
  :root{
    --bg:#F3F2EF;--card:#fff;--text:#111827;--muted:#6B7280;--border:#E5E7EB;
    --brand:#0D3B2E;--brand-weak:#E7F0ED;--accent:#0f5a45;--warn:#fffbe6;--warn-b:#f5e79f;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,sans-serif}
  .topbar{height:56px;background:var(--card);border-bottom:1px solid var(--border);
    display:flex;align-items:center;justify-content:space-between;padding:0 16px;position:sticky;top:0;z-index:10}
  .brand{font-weight:800;color:var(--brand)} .hint{color:var(--muted);font-size:12px}
  .container{max-width:1100px;margin:16px auto;padding:0 12px;display:grid;grid-template-columns:360px 1fr;gap:16px}
  @media (max-width:980px){.container{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .title{padding:12px 16px;font-weight:700;color:var(--brand);border-bottom:1px solid var(--border)}
  .content{padding:14px 16px;line-height:1.65}
  .section-title{padding:14px 16px;font-weight:700;border-bottom:1px solid var(--border);color:var(--brand)}
  .body{padding:14px 16px}
  .row{display:flex;gap:10px;margin-bottom:10px}
  input[type=text],textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#FAFAFA;outline:none}
  textarea{min-height:140px;resize:vertical}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:1px solid transparent;cursor:pointer;transition:all .15s ease}
  .btn-primary{background:var(--brand);color:#fff}.btn-primary:hover{opacity:.9}
  .btn-ghost{background:#EEF2F3;color:var(--brand);border-color:#DDE4E6}.btn-ghost:hover{background:#E7ECEE}
  .btn-danger{background:#fee2e2;color:#991b1b;border-color:#fecaca}

  .pill{display:inline-block;padding:4px 8px;background:var(--brand-weak);border-radius:999px;margin:0 6px 6px 0}
  .muted{color:var(--muted);font-size:12px}
  .banner{background:var(--warn);border:1px solid var(--warn-b);color:#8b6a00;padding:8px 12px;border-radius:10px;margin-bottom:12px;font-size:13px}

  .progress-wrap{background:#EEF2F3;border:1px solid var(--border);border-radius:10px;overflow:hidden;height:16px}
  .progress-bar{height:100%;background:linear-gradient(90deg,var(--brand),#178066);width:0%;color:#fff;font-size:12px;
    display:flex;align-items:center;justify-content:center;transition:width .3s ease}
  .progress-text{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}

  .skeleton{background:linear-gradient(90deg,#f3f4f6,#e5e7eb,#f3f4f6);background-size:200% 100%;animation:s 1.2s linear infinite;border-radius:8px;height:14px;margin:6px 0}
  @keyframes s{0%{background-position:200% 0}100%{background-position:-200% 0}}

  .error{background:#fff1f2;border:1px solid #fecdd3;color:#7f1d1d;border-radius:8px;padding:8px 10px}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Alsos AI Resume</div>
    <div class="hint">é»˜è®¤æ€è€ƒæ¨¡å¼ï¼ˆå†…å®¹æ›´æ·±å…¥ï¼‰</div>
  </div>

  <div class="container">
    <div class="card">
      <div class="section-title">è¾“å…¥åŒº</div>
      <div class="body">
        <div class="row"><input type="file" id="resumeFile" accept=".txt,.docx"/></div>
        <div class="row"><textarea id="resumeText" placeholder="â‘  ç²˜è´´ç®€å†ï¼ˆä¸­/è‹±ï¼‰&#10;â‘¡ æˆ–ä¸Šä¼  .txt/.docx è‡ªåŠ¨å¡«å……"></textarea></div>
        <div class="row"><input id="targetTitle" type="text" placeholder="ç›®æ ‡èŒä½"/></div>
        <div class="row"><input id="targetLocation" type="text" placeholder="æœŸæœ›åœ°ç‚¹"/></div>
        <div class="row"><input id="targetIndustry" type="text" placeholder="ç›®æ ‡è¡Œä¸šï¼ˆå¯é€‰ï¼‰"/></div>
        <div class="row"><textarea id="jobDescription" placeholder="ç›®æ ‡èŒä½ JDï¼ˆå¯é€‰ï¼Œç”¨äº ATSï¼‰"></textarea></div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" id="btnGenerate">ä¸€é”®ç”Ÿæˆï¼ˆæ€è€ƒï¼‰</button>
          <button class="btn btn-ghost" id="btnGenerateFast">æé€Ÿæ¨¡å¼ï¼ˆè¾ƒå¿«ï¼‰</button>
          <button class="btn btn-danger" id="btnCancel" style="display:none">å–æ¶ˆç”Ÿæˆ</button>
        </div>
        <div class="muted">ç”Ÿæˆè¿‡ç¨‹ä¸­æ¨¡å—å°†é™†ç»­å‡ºç°ï¼›é•¿æ–‡æ¡£éœ€è¦æ›´ä¹…ã€‚</div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">æ­£åœ¨åˆ†æç®€å†</div>
      <div class="content">
        <div class="progress-wrap"><div class="progress-bar" id="pgbar">0%</div></div>
        <div class="progress-text" id="pgtext">è«ç€æ€¥ã€è«ç€æ€¥ï¼Œä½ çš„ç®€å†å¾ˆç²¾å½©ï¼Œå®¹æˆ‘è®¤çœŸæ‹œè¯»ï½</div>
      </div>
    </div>

    <div id="feed"></div>
  </div>

<script>
const $ = s => document.querySelector(s);
const feed = $("#feed");
let controller = null;          // AbortController
let watchdog = null;            // çœ‹é—¨ç‹—ï¼ˆé•¿æ—¶é—´æ— è¾“å‡ºçš„å…œåº•ï¼‰
let slowHintShown = false;
let progressTimer = null;
let baseProgress = 0;           // æ¨¡æ‹Ÿè¿›åº¦ï¼ˆæ— æ•°æ®æ—¶ä¹Ÿæ…¢æ…¢å‰è¿›ï¼‰
let sectionsDone = 0;
let sectionsTotal = 8;          // åˆå§‹é¢„ä¼°ï¼›æ”¶åˆ° done åç”¨ has_jd çº æ­£
const SECTION_TITLES = {
  "summary_highlights":"ğŸ“Œ æ¦‚è§ˆ / äº®ç‚¹",
  "improvements":"ğŸ› ï¸ ç®€å†ä¼˜åŒ–å»ºè®®",
  "career_diagnosis":"ğŸ§­ èŒä¸šè½¨è¿¹è¯Šæ–­",
  "career_level":"ğŸ·ï¸ Level åˆ¤å®šä¸è·¯å¾„",
  "personalized_strategy":"ğŸ“ˆ æ±‚èŒç­–ç•¥ï¼ˆä¸ªæ€§åŒ–ï¼‰",
  "interview":"ğŸ“– é¢è¯•æ‰‹å†Œ",
  "salary":"ğŸ’° è–ªé…¬ä¼°ç®—",
  "ats":"ğŸ“Š ATS åŒ¹é…"
};

// ---------- UI å°å·¥å…· ----------
function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function card(id, title, inner=""){
  const el = document.createElement("div");
  el.className="card"; el.id=id;
  el.innerHTML=`<div class="title">${title}</div><div class="content">${inner}</div>`;
  feed.appendChild(el);
  return el.querySelector(".content");
}
function ensureSkeleton(section){
  const id = `sec-${section}`;
  if(document.getElementById(id)) return;
  const c = card(id, SECTION_TITLES[section]||section, `
    <div class="skeleton" style="width:70%"></div>
    <div class="skeleton" style="width:90%"></div>
    <div class="skeleton" style="width:60%"></div>`);
  return c;
}
function showError(section, msg){
  const id = `sec-${section}`;
  const el = document.getElementById(id) || card(id, SECTION_TITLES[section]||section);
  el.innerHTML = `<div class="error">âš ï¸ ${escapeHtml(msg||"æœªçŸ¥é”™è¯¯")}</div>`;
}
function updateProgress(realDone=false){
  // æ¨¡æ‹Ÿè¿›åº¦ï¼šæ¯0.8s +1~2%ï¼Œä½†ä¸è¶…è¿‡ 80%
  if(!realDone){
    baseProgress = Math.min(80, baseProgress + (Math.random()*1.5+0.5));
  }
  const logical = Math.floor((sectionsDone/Math.max(1,sectionsTotal))*100);
  const percent = Math.max(Math.min(100, logical), Math.floor(baseProgress));
  const bar = $("#pgbar");
  bar.style.width = percent + "%";
  bar.textContent = percent + "%";
}

// ---------- æ¸²æŸ“æ¯ä¸ªæ¨¡å— ----------
function renderPiece(section, data){
  const id = `sec-${section}`;
  let el = document.getElementById(id)?.querySelector(".content");
  if(!el){ el = card(id, SECTION_TITLES[section]||section); }

  // è¿™é‡Œä¸ºäº†ä¿è¯â€œå…ˆçœ‹åˆ°ä¸œè¥¿â€ï¼Œå…ˆç»™ä¸ªå ä½ï¼Œå†æ›¿æ¢
  if(!data || Object.keys(data).length===0){
    el.innerHTML = `<div class="skeleton" style="width:85%"></div>
                    <div class="skeleton" style="width:70%"></div>`;
    return;
  }

  if(section==="summary_highlights"){
    const s = data.summary || "";
    const hl = data.highlights || [];
    el.innerHTML = `<div class="banner">å¼•æ“ï¼šAlsos AI Resume</div>
                    <p>${escapeHtml(s)}</p>
                    ${hl.length? `<ul>${hl.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>`:"<div class='muted'>äº®ç‚¹å¾…è¡¥å……</div>"}`;
  }
  else if(section==="improvements"){
    const arr = data.resume_improvements||[];
    el.innerHTML = arr.length? arr.map((it,i)=>`
      <div style="margin-bottom:10px">
        <div><b>${i+1}. é—®é¢˜ç‚¹ï¼š</b>${escapeHtml(it.issue||"")}</div>
        <div><b>æ”¹è¿›æ–¹æ¡ˆï¼š</b>${escapeHtml(it.fix||"")}</div>
        <div class="muted"><b>åŸå› ï¼š</b>${escapeHtml(it.why||"")}</div>
      </div>`).join("") : "<div class='muted'>æš‚æ— </div>";
  }
  else if(section==="career_diagnosis"){
    const items = (data.career_diagnosis||[]).map((it,i)=>`
      <div style="margin-bottom:10px">
        <div><b>${i+1}. å‘ç°ï¼š</b>${escapeHtml(it.issue||"")}</div>
        <div><b>é£é™©ï¼š</b>${escapeHtml(it.risk||"")}</div>
        <div class="muted"><b>åº”å¯¹ç­–ç•¥ï¼š</b>${escapeHtml(it.advice||"")}</div>
      </div>`).join("");
    el.innerHTML = items || "<div class='muted'>æœªæ£€å‡ºæ˜æ˜¾é£é™©</div>";
  }
  else if(section==="career_level"){
    const a = data.career_level_analysis||{};
    const f = a.interview_focus||{};
    el.innerHTML = `
      <div><b>åˆ¤å®š Levelï¼š</b>${escapeHtml(a.level||"-")} <span class="muted">ï¼ˆç†ç”±ï¼š${escapeHtml(a.reason||"-")}ï¼‰</span></div>
      <div style="margin-top:8px"><b>å‘å±•è·¯å¾„å»ºè®®ï¼š</b><ul>${(a.path||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      <div style="margin-top:8px"><b>ä¸åŒ Level é¢è¯•å…³æ³¨ç‚¹ï¼š</b>
        <div><i>Junior</i><ul>${(f.junior||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
        <div><i>Middle</i><ul>${(f.middle||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
        <div><i>Senior</i><ul>${(f.senior||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
        <div><i>Executive</i><ul>${(f.executive||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      </div>`;
  }
  else if(section==="personalized_strategy"){
    const st = data.strategy||{};
    el.innerHTML = `
      <div class="muted">åˆ¤æ–­ä¾æ®ï¼š${escapeHtml(st.assumptions||"")}</div>
      <div style="margin-top:8px"><b>çŸ­æœŸï¼ˆ3-6ä¸ªæœˆï¼‰ï¼š</b><ul>${(st.short_term||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      <div><b>ä¸­æœŸï¼ˆ6-18ä¸ªæœˆï¼‰ï¼š</b><ul>${(st.mid_term||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      <div><b>é•¿æœŸï¼ˆ18ä¸ªæœˆ+ï¼‰ï¼š</b><ul>${(st.long_term||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      ${(st.if_job_hopping&&st.if_job_hopping.length)?`<div><b>è·³æ§½é¢‘ç¹ä¸“é¡¹ï¼š</b><ul>${st.if_job_hopping.map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>`:""}
    `;
  }
  else if(section==="interview"){
    const ih = data.interview_handbook||{};
    el.innerHTML = `
      <div><b>å›ç­”é€»è¾‘ï¼š</b><ul>${(ih.answer_logic||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      <div><b>ä¸åŒé¢è¯•å®˜å…³æ³¨ç‚¹ï¼š</b>
        <div><i>HR</i><ul>${(ih.interviewer_focus?.HR||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
        <div><i>éƒ¨é—¨è´Ÿè´£äºº</i><ul>${(ih.interviewer_focus?.hiring_manager||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
        <div><i>è€æ¿/é«˜å±‚</i><ul>${(ih.interviewer_focus?.executive||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>
      </div>
      <div><b>STAR é¡¹ç›®ç­”é¢˜æç¤ºï¼ˆ3 å¥—ï¼‰ï¼š</b>
        <ol>${(ih.star_sets||[]).map(s=>`<li><b>${escapeHtml(s.project_title||"é¡¹ç›®")}</b> Â· ${escapeHtml(s.question||"")}<ul>${(s.how_to_answer||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></li>`).join("")}</ol>
      </div>
      <div><b>é£é™©ç‚¹åº”å¯¹ï¼š</b><ul>${(ih.risk_mitigation||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>`;
  }
  else if(section==="ats"){
    const ats = data.ats||{};
    if(!ats.enabled){ el.innerHTML = "<div class='muted'>æœªæä¾› JDï¼Œæœªè¿›è¡Œ ATS è¯„åˆ†ã€‚</div>"; return; }
    const bar = n=>`<div style='display:flex;gap:10px;align-items:center;margin:4px 0'>
      <div style='flex:1;height:12px;background:#EEF2F3;border:1px solid #E5E7EB;border-radius:999px;overflow:hidden'>
        <div style='height:100%;background:#0D3B2E;width:${Math.max(0,Math.min(100,Number(n||0)))}%'></div>
      </div><span class='muted' style='width:48px;text-align:right'>${n||0}/100</span></div>`;
    const rs = ats.reasons||{};
    el.innerHTML = `
      <div><b>æ€»åˆ†ï¼š</b>${bar(ats.total_score||0)}</div>
      <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:8px;">
        <div><b>æŠ€èƒ½</b>${bar(ats.sub_scores?.skills||0)}<div class="muted">${(rs.skills||[]).join(" Â· ")}</div></div>
        <div><b>ç»éªŒ</b>${bar(ats.sub_scores?.experience||0)}<div class="muted">${(rs.experience||[]).join(" Â· ")}</div></div>
        <div><b>æ•™è‚²</b>${bar(ats.sub_scores?.education||0)}<div class="muted">${(rs.education||[]).join(" Â· ")}</div></div>
        <div><b>å…³é”®è¯</b>${bar(ats.sub_scores?.keywords||0)}<div class="muted">${(rs.keywords||[]).join(" Â· ")}</div></div>
      </div>
      <div style="margin-top:8px;"><b>ç¼ºå£å…³é”®è¯ï¼š</b>${(ats.gap_keywords||[]).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join("")}</div>
      <div style="margin-top:8px;"><b>ä¼˜åŒ–å»ºè®®ï¼š</b><ul>${(ats.improvement_advice||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul></div>`;
  }
  else if(section==="salary"){
    const s = data.salary_insights||{}, c = s.currency||"CNY";
    const line = (label,val,min,max)=>{
      const hi=Number(max||0), lo=Number(min||0), v=Number(val||0);
      const pct = hi>lo ? Math.max(5,Math.min(100,Math.round((v-lo)/(hi-lo)*100))) : 5;
      return `<div style="display:flex;align-items:center;gap:10px;margin:6px 0">
        <div style="width:36px" class="muted">${label}</div>
        <div style="flex:1;height:12px;background:#EEF2F3;border:1px solid #E5E7EB;border-radius:999px;overflow:hidden">
          <div style="height:100%;background:#0D3B2E;width:${pct}%"></div>
        </div>
        <div style="width:120px;text-align:right" class="muted">${c} ${v}</div></div>`;
    };
    el.innerHTML = `<div><b>${escapeHtml(s.city||"-")} Â· ${escapeHtml(s.title||"-")}</b></div>
      ${line("ä½ä½",s.low,s.low,s.high)}${line("ä¸­ä½",s.mid,s.low,s.high)}${line("é«˜ä½",s.high,s.low,s.high)}
      <div class="muted">å½±å“å› å­ï¼š${(s.factors||[]).join(" Â· ")}</div>
      <div class="muted">${escapeHtml(s.notes||"æ¨¡å‹ä¼°ç®—ï¼Œä¾›å‚è€ƒ")}</div>`;
  }
}

// ---------- çœ‹é—¨ç‹—ï¼šé•¿æœŸæ— è¾“å‡ºæ—¶ç»™æç¤º ----------
function armWatchdog(mode){
  clearTimeout(watchdog); slowHintShown=false;
  watchdog = setTimeout(()=>{
    if(slowHintShown) return;
    slowHintShown = true;
    const tip = document.createElement("div");
    tip.className="card";
    tip.innerHTML = `<div class="title">â³ æ­£åœ¨åŠªåŠ›ç”Ÿæˆ</div>
      <div class="content">
        <div class="muted">æ€è€ƒæ¨¡å¼åœ¨é•¿æ–‡æ¡£æƒ…å†µä¸‹å¯èƒ½è¾ƒæ…¢ã€‚ä½ å¯ä»¥ç»§ç»­ç­‰å¾…ï¼Œæˆ–å°è¯•â€œæé€Ÿæ¨¡å¼â€ä»¥å…ˆè·å¾—é¦–ç‰ˆæŠ¥å‘Šã€‚</div>
        <div style="margin-top:8px">
          <button class="btn btn-ghost" id="retryFast">åˆ‡æ¢æé€Ÿæ¨¡å¼é‡è¯•</button>
        </div>
      </div>`;
    feed.prepend(tip);
    $("#retryFast").onclick = ()=>{ cancelStream(); startStream("speed"); };
  }, 90000); // 90s æ— è¾“å‡ºæ—¶æç¤º
}

// ---------- å¯åŠ¨æµ ----------
async function startStream(mode="depth"){
  // æ¸…ç†
  feed.innerHTML = "";
  sectionsDone = 0; baseProgress = 0; sectionsTotal = 8;
  updateProgress(true);
  $("#btnCancel").style.display="inline-flex";

  // é¢„ç½®æ‰€æœ‰æ¨¡å—éª¨æ¶ï¼ˆè®©ç”¨æˆ·ç«‹åˆ»â€œçœ‹åˆ°ä¸œè¥¿â€ï¼‰
  ["career_diagnosis","improvements","summary_highlights","career_level",
   "personalized_strategy","interview","salary","ats"].forEach(ensureSkeleton);

  // è¿›åº¦æ¡æ¨¡æ‹Ÿå‰è¿›
  clearInterval(progressTimer);
  progressTimer = setInterval(()=>updateProgress(false), 800);

  controller = new AbortController();
  armWatchdog(mode);

  const body = {
    resume_text: $("#resumeText").value.trim(),
    job_description: $("#jobDescription").value.trim(),
    target_title: $("#targetTitle").value.trim(),
    target_location: $("#targetLocation").value.trim(),
    target_industry: $("#targetIndustry").value.trim(),
    model: mode==="speed" ? "speed" : "depth"
  };
  if(!body.resume_text){ alert("è¯·ç²˜è´´ç®€å†æ–‡æœ¬æˆ–ä¸Šä¼ æ–‡ä»¶"); cancelStream(); return; }

  const res = await fetch("/optimize_stream",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(body),
    signal: controller.signal
  });

  if(!res.ok){ cancelStream(); feed.innerHTML=`<div class="card"><div class="title">æœåŠ¡å¼‚å¸¸</div><div class="content">è¯·ç¨åå†è¯•</div></div>`; return; }

  const decoder = new TextDecoder("utf-8");
  const reader = res.body.getReader();
  let buf = "";

  while(true){
    const {value, done} = await reader.read();
    if(done) break;
    clearTimeout(watchdog); armWatchdog(mode);   // æ”¶åˆ°æ•°æ®é‡ç½®çœ‹é—¨ç‹—

    buf += decoder.decode(value,{stream:true});
    const parts = buf.split("\n\n");
    for(let i=0;i<parts.length-1;i++){
      const line = parts[i].trim();
      if(!line) continue;
      if(line.startsWith(":")) continue; // å¿ƒè·³
      if(!line.startsWith("data:")) continue;

      try{
        const payload = JSON.parse(line.slice(5).trim());
        if(payload.section==="done"){
          // æ ¹æ® has_jd ä¿®æ­£æ€»æ•°ï¼Œå®Œæˆ=100%
          if(payload.data && payload.data.meta && typeof payload.data.meta.has_jd==="boolean"){
            sectionsTotal = payload.data.meta.has_jd ? 8 : 7;
          }
          sectionsDone = sectionsTotal; updateProgress(true);
          continue;
        }
        if(payload.error){
          showError(payload.section, payload.error);
        }else{
          renderPiece(payload.section, payload.data);
        }
        sectionsDone++; updateProgress(true);
      }catch(e){
        // JSON è§£æå¤±è´¥ï¼šå¿½ç•¥è¯¥ç‰‡æ®µï¼Œç»§ç»­
      }
    }
    buf = parts[parts.length-1];
  }
  cancelStream();
}

function cancelStream(){
  if(controller){ controller.abort(); controller=null; }
  clearInterval(progressTimer);
  clearTimeout(watchdog);
  $("#btnCancel").style.display="none";
  // ç»“æŸæ—¶æŠŠè¿›åº¦æ¡æ‹‰æ»¡
  const bar=$("#pgbar"); bar.style.width="100%"; bar.textContent="100%";
}

// ---------- äº‹ä»¶ ----------
$("#btnGenerate").addEventListener("click", ()=>startStream("depth"));
$("#btnGenerateFast").addEventListener("click", ()=>startStream("speed"));
$("#btnCancel").addEventListener("click", cancelStream);
$("#resumeFile").addEventListener("change", async (e)=>{
  const f=e.target.files[0]; if(!f) return; const fd=new FormData(); fd.append("file", f);
  const r=await fetch("/extract-text",{method:"POST",body:fd}); const j=await r.json();
  if(j.ok) $("#resumeText").value=j.text||"";
});
</script>
</body>
</html>
