<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Alsos AI Resume · 求职助手</title>
<style>
  :root{--bg:#F3F2EF;--card:#fff;--text:#111827;--muted:#6B7280;--border:#E5E7EB;
        --brand:#0D3B2E;--brand-weak:#E7F0ED;--warn:#fffbe6;--warn-b:#f5e79f}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",Arial,sans-serif}
  .topbar{height:56px;background:var(--card);border-bottom:1px solid var(--border);
          display:flex;align-items:center;justify-content:space-between;padding:0 16px;position:sticky;top:0;z-index:10}
  .brand{font-weight:800;color:var(--brand)} .hint{color:var(--muted);font-size:12px}

  .container{max-width:1100px;margin:16px auto;padding:0 12px;
             display:grid;grid-template-columns:360px 1fr;gap:16px;align-items:start}
  @media (max-width:980px){.container{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .title{padding:12px 16px;font-weight:700;color:var(--brand);border-bottom:1px solid var(--border)}
  .content{padding:14px 16px;line-height:1.65}
  .section-title{padding:14px 16px;font-weight:700;border-bottom:1px solid var(--border);color:var(--brand)}
  .body{padding:14px 16px}

  .row{display:flex;gap:10px;margin-bottom:10px}
  input[type=text],textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#FAFAFA;outline:none}
  textarea{min-height:140px;resize:vertical}
  .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:1px solid transparent;cursor:pointer;transition:all .15s ease}
  .btn-primary{background:var(--brand);color:#fff}.btn-primary:hover{opacity:.9}
  .btn-ghost{background:#EEF2F3;color:var(--brand);border-color:#DDE4E6}.btn-ghost:hover{background:#E7ECEE}
  .btn-danger{background:#fee2e2;color:#991b1b;border-color:#fecaca}

  .pill{display:inline-block;padding:4px 8px;background:var(--brand-weak);border-radius:999px;margin:0 6px 6px 0}
  .muted{color:var(--muted);font-size:12px}
  .banner{background:var(--warn);border:1px solid var(--warn-b);color:#8b6a00;padding:8px 12px;border-radius:10px;margin-bottom:12px;font-size:13px}

  .progress-wrap{background:#EEF2F3;border:1px solid var(--border);border-radius:10px;overflow:hidden;height:16px}
  .progress-bar{height:100%;background:linear-gradient(90deg,var(--brand),#178066);width:0%;color:#fff;font-size:12px;
    display:flex;align-items:center;justify-content:center;transition:width .3s ease}
  .progress-text{margin-top:8px;color:var(--muted);font-size:13px;text-align:center}

  .skeleton{background:linear-gradient(90deg,#f3f4f6,#e5e7eb,#f3f4f6);background-size:200% 100%;animation:s 1.2s linear infinite;border-radius:8px;height:14px;margin:6px 0}
  @keyframes s{0%{background-position:200% 0}100%{background-position:-200% 0}}

  .error{background:#fff1f2;border:1px solid #fecdd3;color:#7f1d1d;border-radius:8px;padding:8px 10px}

  .right{grid-column:2 / -1; display:flex; flex-direction:column; gap:16px; align-items:stretch}
  .progress-card{margin-bottom:0}
  #feed{display:flex; flex-direction:column; gap:16px}

  /* 薪酬条形：固定容器宽度，内部 width 用百分比 */
  .bar-row{display:flex;gap:10px;align-items:center;margin:6px 0}
  .bar-box{flex:1;height:12px;background:#EEF2F3;border:1px solid #E5E7EB;border-radius:999px;overflow:hidden}
  .bar-inner{height:100%;background:#0D3B2E;width:0%}
  .bar-text{width:64px;text-align:right;font-size:12px;color:#374151}
  /* 打字机效果 */
  .tw{white-space:pre-wrap}
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Alsos AI Resume</div>
    <div class="hint">默认思考模式（内容更深入）</div>
  </div>

  <div class="container">
    <!-- 左列 -->
    <div class="card">
      <div class="section-title">输入区</div>
      <div class="body">
        <div class="row"><input type="file" id="resumeFile" accept=".txt,.docx"/></div>
        <div class="row"><textarea id="resumeText" placeholder="粘贴简历（中/英）或上传 .txt/.docx"></textarea></div>
        <div class="row"><input id="targetTitle" type="text" placeholder="目标职位"/></div>
        <div class="row"><input id="targetLocation" type="text" placeholder="期望地点"/></div>
        <div class="row"><input id="targetIndustry" type="text" placeholder="目标行业（可选）"/></div>
        <div class="row"><textarea id="jobDescription" placeholder="目标职位 JD（可选，用于 ATS与教育要求识别）"></textarea></div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" id="btnGenerate">一键生成（思考）</button>
          <button class="btn btn-ghost" id="btnBalanced">平衡模式（提速）</button>
          <button class="btn btn-ghost" id="btnGenerateFast">极速模式（较快）</button>
          <button class="btn btn-danger" id="btnCancel" style="display:none">取消生成</button>
        </div>
        <div class="muted">模块会陆续出现；打字机逐字呈现，等候更友好。</div>
      </div>
    </div>

    <!-- 右列 -->
    <div class="right">
      <div class="card progress-card">
        <div class="section-title">正在分析简历</div>
        <div class="content">
          <div class="progress-wrap"><div class="progress-bar" id="pgbar">0%</div></div>
          <div class="progress-text" id="pgtext">莫着急、莫着急，你的简历很精彩，容我认真拜读～</div>
        </div>
      </div>
      <div id="feed"></div>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const feed = $("#feed");
let controller = null, watchdog = null, progressTimer = null;
let baseProgress = 0, sectionsDone = 0, sectionsTotal = 8;

const SECTION_TITLES = {
  "summary_highlights":"📌 概览 / 亮点",
  "improvements":"🛠️ 简洁版简历优化（Top 6）",
  "career_diagnosis":"🧭 职业轨迹诊断（仅命中项）",
  "career_level":"🏷️ Level 判定与路径（精简）",
  "personalized_strategy":"📈 求职策略（个性化、短中长）",
  "interview":"📖 面试手册（对应级别）",
  "salary":"💰 薪酬估算（模型参考）",
  "ats":"📊 ATS 匹配"
};

function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
function card(id, title, inner=""){const el=document.createElement("div");el.className="card";el.id=id;el.innerHTML=`<div class="title">${title}</div><div class="content">${inner}</div>`;feed.appendChild(el);return el.querySelector(".content");}
function ensureSkeleton(section){const id=`sec-${section}`;if(document.getElementById(id))return;card(id,SECTION_TITLES[section]||section,`<div class="skeleton" style="width:70%"></div><div class="skeleton" style="width:88%"></div><div class="skeleton" style="width:60%"></div>`);}
function showError(section,msg){const id=`sec-${section}`;const el=document.getElementById(id) || card(id,SECTION_TITLES[section]||section);el.innerHTML=`<div class="error">⚠️ ${escapeHtml(msg||"未知错误")}</div>`;}

function updateProgress(real=false){
  if(!real){baseProgress=Math.min(80,baseProgress+(Math.random()*1.5+0.5));}
  const logical=Math.floor((sectionsDone/Math.max(1,sectionsTotal))*100);
  const pct=Math.max(Math.min(100,logical),Math.floor(baseProgress));
  const bar=$("#pgbar"); bar.style.width=pct+"%"; bar.textContent=pct+"%";
}

/* ---------- 打字机 ---------- */
function typeWrite(el, text, speed=8){ // 每字符 8ms，中文也OK
  text = String(text||"");
  el.classList.add("tw");
  el.textContent="";
  let i=0;
  return new Promise(resolve=>{
    const timer=setInterval(()=>{
      el.textContent += text[i]||"";
      i++; if(i>=text.length){clearInterval(timer);resolve();}
    }, speed);
  });
}
async function typeList(el, arr){
  el.innerHTML = "<ul></ul>";
  const ul = el.querySelector("ul");
  for (const item of (arr||[])){
    const li=document.createElement("li");
    ul.appendChild(li);
    await typeWrite(li, item, 8);
  }
}

/* ---------- 渲染 ---------- */
async function renderPiece(section, data){
  const id=`sec-${section}`;let el=document.getElementById(id)?.querySelector(".content");
  if(!el){ el=card(id,SECTION_TITLES[section]||section); }
  if(!data || Object.keys(data).length===0){ el.innerHTML=`<div class="skeleton" style="width:85%"></div>`; return; }

  if(section==="summary_highlights"){
    const s=data.summary||"", hl=data.highlights||[];
    el.innerHTML=`<div class="banner">引擎：Alsos AI Resume</div><p id="sum"></p><div id="hl"></div>`;
    await typeWrite(el.querySelector("#sum"), s);
    await typeList(el.querySelector("#hl"), hl);

  } else if(section==="improvements"){
    const arr=data.resume_improvements||[];
    el.innerHTML = arr.length? arr.map((it,i)=>`<div style="margin-bottom:10px">
      <div><b>${i+1}. 问题：</b><span id="i${i}_a"></span></div>
      <div><b>方案：</b><span id="i${i}_b"></span></div>
      <div class="muted"><b>原因：</b><span id="i${i}_c"></span></div></div>`).join("") : "<div class='muted'>暂无</div>";
    for(let i=0;i<arr.length;i++){
      await typeWrite(el.querySelector(`#i${i}_a`), arr[i].issue||"");
      await typeWrite(el.querySelector(`#i${i}_b`), arr[i].fix||"");
      await typeWrite(el.querySelector(`#i${i}_c`), arr[i].why||"");
    }

  } else if(section==="career_diagnosis"){
    const items=(data.career_diagnosis||[]);
    el.innerHTML = items.length? items.map((it,i)=>`<div style="margin-bottom:10px">
      <div><b>${i+1}. 发现：</b><span id="d${i}_a"></span></div>
      <div><b>风险：</b><span id="d${i}_b"></span></div>
      <div class="muted"><b>建议：</b><span id="d${i}_c"></span></div></div>`).join("") : "<div class='muted'>未命中任何风险项（这很好）。</div>";
    for(let i=0;i<items.length;i++){
      await typeWrite(el.querySelector(`#d${i}_a`), items[i].issue||"");
      await typeWrite(el.querySelector(`#d${i}_b`), items[i].risk||"");
      await typeWrite(el.querySelector(`#d${i}_c`), items[i].advice||"");
    }

  } else if(section==="career_level"){
    const a=data.career_level_analysis||{}, f=a.interview_focus||{};
    el.innerHTML=`<div><b>判定 Level：</b><span id="lv"></span> <span class="muted">（理由：<span id="lv_r"></span>）</span></div>
    <div style="margin-top:8px"><b>发展路径建议：</b><div id="path"></div></div>
    <div style="margin-top:8px"><b>不同 Level 面试关注点：</b>
      <div><i>Junior</i><div id="f_j"></div></div>
      <div><i>Middle</i><div id="f_m"></div></div>
      <div><i>Senior</i><div id="f_s"></div></div>
      <div><i>Executive</i><div id="f_e"></div></div>
    </div>`;
    await typeWrite(el.querySelector("#lv"), a.level||"-");
    await typeWrite(el.querySelector("#lv_r"), a.reason||"-");
    await typeList(el.querySelector("#path"), a.path||[]);
    await typeList(el.querySelector("#f_j"), f.junior||[]);
    await typeList(el.querySelector("#f_m"), f.middle||[]);
    await typeList(el.querySelector("#f_s"), f.senior||[]);
    await typeList(el.querySelector("#f_e"), f.executive||[]);

  } else if(section==="personalized_strategy"){
    const st=data.strategy||{};
    el.innerHTML=`<div class="muted"><span id="ass"></span></div>
    <div style="margin-top:8px"><b>短期（3-6个月）：</b><div id="st_s"></div></div>
    <div><b>中期（6-18个月）：</b><div id="st_m"></div></div>
    <div><b>长期（18个月+）：</b><div id="st_l"></div></div>
    ${(st.if_job_hopping&&st.if_job_hopping.length)?`<div><b>跳槽频繁专项：</b><div id="st_h"></div></div>`:""}`;
    await typeWrite(el.querySelector("#ass"), st.assumptions||"");
    await typeList(el.querySelector("#st_s"), st.short_term||[]);
    await typeList(el.querySelector("#st_m"), st.mid_term||[]);
    await typeList(el.querySelector("#st_l"), st.long_term||[]);
    if(st.if_job_hopping) await typeList(el.querySelector("#st_h"), st.if_job_hopping||[]);

  } else if(section==="interview"){
    const ih=data.interview_handbook||{};
    el.innerHTML=`<div><b>回答逻辑：</b><div id="ans"></div></div>
    <div style="margin-top:4px"><b>不同面试官关注点：</b>
      <div><i>HR</i><div id="fh"></div></div>
      <div><i>部门负责人</i><div id="fm"></div></div>
      <div><i>老板/高层</i><div id="fe"></div></div>
    </div>
    <div style="margin-top:4px"><b>STAR 项目答题提示（3 套）：</b><ol id="stars"></ol></div>
    <div><b>风险点应对：</b><div id="risk"></div></div>`;
    await typeList(el.querySelector("#ans"), ih.answer_logic||[]);
    await typeList(el.querySelector("#fh"), ih.interviewer_focus?.HR||[]);
    await typeList(el.querySelector("#fm"), ih.interviewer_focus?.hiring_manager||[]);
    await typeList(el.querySelector("#fe"), ih.interviewer_focus?.executive||[]);
    // stars
    const stars = ih.star_sets||[];
    const ol = el.querySelector("#stars");
    for(const s of stars){
      const li=document.createElement("li");
      li.innerHTML = `<b>${escapeHtml(s.project_title||"项目")}</b> · ${escapeHtml(s.question||"")}<ul></ul>`;
      ol.appendChild(li);
      await typeList(li.querySelector("ul"), s.how_to_answer||[]);
    }
    await typeList(el.querySelector("#risk"), ih.risk_mitigation||[]);

  } else if(section==="ats"){
    const ats=data.ats||{};
    if(!ats.enabled){ el.innerHTML="<div class='muted'>未提供 JD，未进行 ATS 评分。</div>"; return; }
    el.innerHTML=`<div><b>总分：</b>
      <div class="bar-row"><div class="bar-box"><div class="bar-inner" id="b0"></div></div><span class="bar-text" id="t0"></span></div></div>
      <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:8px;">
        <div><b>技能</b><div class="bar-row"><div class="bar-box"><div class="bar-inner" id="b1"></div></div><span class="bar-text" id="t1"></span></div><div class="muted">${(ats.reasons?.skills||[]).join(" · ")}</div></div>
        <div><b>经验</b><div class="bar-row"><div class="bar-box"><div class="bar-inner" id="b2"></div></div><span class="bar-text" id="t2"></span></div><div class="muted">${(ats.reasons?.experience||[]).join(" · ")}</div></div>
        <div><b>教育</b><div class="bar-row"><div class="bar-box"><div class="bar-inner" id="b3"></div></div><span class="bar-text" id="t3"></span></div><div class="muted">${(ats.reasons?.education||[]).join(" · ")}</div></div>
        <div><b>关键词</b><div class="bar-row"><div class="bar-box"><div class="bar-inner" id="b4"></div></div><span class="bar-text" id="t4"></span></div><div class="muted">${(ats.reasons?.keywords||[]).join(" · ")}</div></div>
      </div>
      <div style="margin-top:8px;"><b>缺口关键词：</b>${(ats.gap_keywords||[]).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join("")}</div>
      <div style="margin-top:8px;"><b>优化建议：</b><div id="advs"></div></div>`;
    const nums=[ats.total_score||0, ats.sub_scores?.skills||0, ats.sub_scores?.experience||0, ats.sub_scores?.education||0, ats.sub_scores?.keywords||0];
    nums.forEach((n,i)=>{const x=Math.max(0,Math.min(100,Number(n))); el.querySelector("#t"+i).textContent = `${x}/100`; el.querySelector("#b"+i).style.width = x+"%";});
    await typeList(el.querySelector("#advs"), ats.improvement_advice||[]);

  } else if(section==="salary"){
    const s=data.salary_insights||{};
    const pct = (v,lo,hi)=>{ if(!hi||hi<=lo) return 0; return Math.round(((v-lo)/(hi-lo))*100); };
    el.innerHTML=`<div class="muted">${escapeHtml(s.title||"")} · ${escapeHtml(s.city||"")} · ${escapeHtml(s.currency||"")}</div>
      <div class="bar-row"><div class="bar-box"><div class="bar-inner" id="sl"></div></div><span class="bar-text">${s.low||0}</span></div>
      <div class="bar-row"><div class="bar-box"><div class="bar-inner" id="sm"></div></div><span class="bar-text">${s.mid||0}</span></div>
      <div class="bar-row"><div class="bar-box"><div class="bar-inner" id="sh"></div></div><span class="bar-text">${s.high||0}</span></div>
      <div style="margin-top:8px;"><b>影响因子：</b><div id="sf"></div></div>
      <div class="muted" style="margin-top:4px;">${escapeHtml(s.notes||"模型估算，供参考")}</div>`;
    const lo=Number(s.low||0), mi=Number(s.mid||0), hi=Number(s.high||0);
    el.querySelector("#sl").style.width = "5%"; // 低档仅作位置参考
    el.querySelector("#sm").style.width = (hi>lo? pct(mi,lo,hi):50)+"%";
    el.querySelector("#sh").style.width = "100%";
    await typeList(el.querySelector("#sf"), s.factors||[]);

  } else {
    if(data && data._raw_preview){
      el.innerHTML=`<div class="error">⚠️ 该模块返回结构不完整，已降级展示原文片段：</div><pre style="white-space:pre-wrap">${escapeHtml(data._raw_preview)}</pre>`;
    }else{
      el.innerHTML=`<div class="muted">已收到内容，但结构较空，原始数据：</div><pre style="white-space:pre-wrap">${escapeHtml(JSON.stringify(data||{},null,2))}</pre>`;
    }
  }
}

/* ---------- 流/控制 ---------- */
function armWatchdog(mode){
  clearTimeout(watchdog);
  watchdog=setTimeout(()=>{
    const tip=document.createElement("div"); tip.className="card";
    tip.innerHTML=`<div class="title">⏳ 正在努力生成</div><div class="content">
      <div class="muted">思考模式在长文档下会慢一些。你可以继续等，或试试“平衡/极速模式”。</div>
      <div style="margin-top:8px"><button class="btn btn-ghost" id="retryFast">切换极速模式重试</button></div></div>`;
    feed.prepend(tip); $("#retryFast").onclick=()=>{ cancelStream(); startStream("speed"); };
  }, 90000);
}

async function startStream(mode="depth"){
  feed.innerHTML=""; sectionsDone=0; baseProgress=0; sectionsTotal=8; updateProgress(true);
  $("#btnCancel").style.display="inline-flex";
  ["career_diagnosis","improvements","summary_highlights","career_level","personalized_strategy","interview","salary","ats"].forEach(ensureSkeleton);
  clearInterval(progressTimer); progressTimer=setInterval(()=>updateProgress(false),800);
  controller=new AbortController(); armWatchdog(mode);

  const body={
    resume_text: $("#resumeText").value.trim(),
    job_description: $("#jobDescription").value.trim(),
    target_title: $("#targetTitle").value.trim(),
    target_location: $("#targetLocation").value.trim(),
    target_industry: $("#targetIndustry").value.trim(),
    model: mode
  };
  if(!body.resume_text){ alert("请粘贴简历文本或上传文件"); cancelStream(); return; }

  const res=await fetch("/optimize_stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body),signal:controller.signal});
  if(!res.ok){ cancelStream(); feed.innerHTML=`<div class="card"><div class="title">服务异常</div><div class="content">请稍后再试</div></div>`; return; }

  const decoder=new TextDecoder("utf-8"); const reader=res.body.getReader(); let buf="";
  while(true){
    const {value,done}=await reader.read(); if(done) break;
    clearTimeout(watchdog); armWatchdog(mode);
    buf += decoder.decode(value,{stream:true});
    const parts=buf.split("\n\n");
    for(let i=0;i<parts.length-1;i++){
      const line=parts[i].trim(); if(!line||line.startsWith(":")||!line.startsWith("data:")) continue;
      try{
        const payload=JSON.parse(line.slice(5).trim());
        if(payload.section==="boot"){
          const tip=document.createElement("div"); tip.className="card";
          tip.innerHTML=`<div class="title">引擎已启动</div><div class="content"><div class="muted">${escapeHtml(payload.data.msg||"正在准备…")}</div></div>`;
          feed.prepend(tip); continue;
        }
        if(payload.section==="done"){
          if(payload.data && payload.data.meta && typeof payload.data.meta.has_jd==="boolean"){
            sectionsTotal = payload.data.meta.has_jd ? 8 : 7;
          }
          sectionsDone = sectionsTotal; updateProgress(true); continue;
        }
        if(payload.error){ showError(payload.section,payload.error); }
        else{ await renderPiece(payload.section,payload.data); }
        sectionsDone++; updateProgress(true);
      }catch(e){}
    }
    buf = parts[parts.length-1];
  }
  cancelStream();
}

function cancelStream(){ if(controller){controller.abort();controller=null;} clearInterval(progressTimer); clearTimeout(watchdog); $("#btnCancel").style.display="none"; const bar=$("#pgbar"); bar.style.width="100%"; bar.textContent="100%"; }

$("#btnGenerate").addEventListener("click", ()=>startStream("depth"));
$("#btnBalanced").addEventListener("click", ()=>startStream("balanced"));
$("#btnGenerateFast").addEventListener("click", ()=>startStream("speed"));
$("#btnCancel").addEventListener("click", cancelStream);
$("#resumeFile").addEventListener("change", async (e)=>{const f=e.target.files[0]; if(!f) return; const fd=new FormData(); fd.append("file",f); const r=await fetch("/extract-text",{method:"POST",body:fd}); const j=await r.json(); if(j.ok) $("#resumeText").value=j.text||"";});
</script>
</body>
</html>
